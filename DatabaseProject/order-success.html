<!DOCTYPE html>
<html class="wide wow-animation" lang="zh">
  <head>
    <title>è®¢å•æäº¤æˆåŠŸ - ç½‘ä¸Šä¹¦åº—</title>
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <!-- Stylesheets-->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:700%7CLato:300,400,300italic,700">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fonts.css">
  </head>
  <body>
    <!-- Page preloader-->
    <div class="page-loader">
      <div class="page-loader-body">
        <div class="preloader-wrapper big active">
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Page-->
    <div class="page">
      <!-- Page Header-->
      <header class="section page-header">
        <!-- RD Navbar-->
        <div class="rd-navbar-wrap rd-navbar-centered">
          <nav class="rd-navbar novi-background" data-layout="rd-navbar-fixed" data-sm-layout="rd-navbar-fixed" data-md-layout="rd-navbar-fixed" data-md-device-layout="rd-navbar-fixed" data-lg-layout="rd-navbar-fullwidth" data-lg-device-layout="rd-navbar-fixed" data-xl-layout="rd-navbar-static" data-xl-device-layout="rd-navbar-static" data-md-stick-up-offset="1px" data-lg-stick-up-offset="1px" data-stick-up="true" data-sm-stick-up="true" data-md-stick-up="true" data-lg-stick-up="true" data-xl-stick-up="true">
            <div class="rd-navbar-inner">
              <!-- RD Navbar Panel-->
              <div class="rd-navbar-panel">
                <!-- RD Navbar Toggle-->
                <button class="rd-navbar-toggle" data-rd-navbar-toggle=".rd-navbar-nav-wrap"><span></span></button>
                <!-- RD Navbar Brand-->
                <div class="rd-navbar-brand"><a class="brand-name" href="index.html"><img class="logo-default" src="images/logo-default-161x57.png" alt="" width="161" height="57"/><img class="logo-inverse" src="images/logo-inverse-161x57.png" alt="" width="161" height="57"/></a></div>
              </div>
            </div>
          </nav>
        </div>
      </header>

      <!-- è®¢å•æˆåŠŸé¡µé¢ -->
      <section class="section section-lg bg-default text-center">
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
              <div class="success-message">
                <div class="icon-success mb-4">
                  <span class="icon mdi mdi-check-circle text-success" style="font-size: 5rem;"></span>
                </div>
                <h2 class="text-success mb-4">è®¢å•æäº¤æˆåŠŸï¼</h2>

                <!-- é‚®ä»¶å‘é€çŠ¶æ€ -->
                <div class="email-status card mb-4" id="emailStatus" style="display: none;">
                  <div class="card-body text-center">
                    <div id="emailStatusContent">
                      <!-- é‚®ä»¶çŠ¶æ€å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                  </div>
                </div>

                <div class="order-info card mb-4">
                  <div class="card-body">
                    <h5 class="card-title">è®¢å•ä¿¡æ¯</h5>
                    <div class="order-details" id="orderDetails">
                      <!-- è®¢å•è¯¦æƒ…å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                  </div>
                </div>
                <p class="text-muted mb-4">æ„Ÿè°¢æ‚¨çš„è´­ä¹°ï¼æˆ‘ä»¬ä¼šå°½å¿«å¤„ç†æ‚¨çš„è®¢å•ã€‚</p>
                <div class="buttons-container">
                  <a href="index.html" class="button button-primary button-nina">è¿”å›é¦–é¡µ</a>
                  <a href="#" class="button button-secondary button-nina ml-2" id="viewOrderBtn">æŸ¥çœ‹è®¢å•</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Footer Default-->
      <footer class="section page-footer page-footer-default novi-background bg-cover text-left footer-form bg-dark">
        <div class="container container-wide">
          <div class="row row-50 justify-content-sm-center">
            <div class="col-md-6 col-xl-3">
              <div class="inset-xxl">
                <h6 class="text-white">å…³äºæˆ‘ä»¬</h6>
                <p class="text-transparent text-spacing-sm">ç½‘ä¸Šä¹¦åº—æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾ä¹¦é”€å”®å¹³å°ï¼Œæä¾›ä¸°å¯Œçš„å›¾ä¹¦èµ„æºå’Œä¾¿æ·çš„è´­ä¹¦ä½“éªŒã€‚æˆ‘ä»¬è‡´åŠ›äºä¸ºè¯»è€…æä¾›ä¼˜è´¨çš„é˜…è¯»æœåŠ¡ã€‚</p>
              </div>
            </div>
            <div class="col-md-6 col-xl-2">
              <h6 class="text-white">å¿«é€Ÿé“¾æ¥</h6>
              <ul class="list-marked list-marked-primary">
                <li><a href="about-us.html">å…³äºæˆ‘ä»¬</a></li>
                <li><a href="#">æœåŠ¡</a></li>
                <li><a href="shop-4-columns-layout.html">å•†åŸ</a></li>
                <li><a href="classic-blog.html">åšå®¢</a></li>
                <li><a href="contacts.html">è”ç³»æˆ‘ä»¬</a></li>
              </ul>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <!-- JavaScript -->
    <script src="js/core.min.js"></script>
    <script src="js/script.js"></script>
    <script>
      // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
      document.addEventListener('DOMContentLoaded', function() {
        // ä»URLè·å–è®¢å•IDå’Œé‚®ä»¶å‘é€çŠ¶æ€
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId');
        const emailSent = urlParams.get('emailSent');

        if (orderId) {
          // åŠ è½½è®¢å•è¯¦æƒ…
          loadOrderDetails(orderId);
          // æ›´æ–°æŸ¥çœ‹è®¢å•æŒ‰é’®é“¾æ¥
          document.getElementById('viewOrderBtn').href = `/user/orders.html?id=${orderId}`;
        }

        // æ˜¾ç¤ºé‚®ä»¶å‘é€çŠ¶æ€
        showEmailStatus(emailSent);
      });

      // åŠ è½½è®¢å•è¯¦æƒ…
      async function loadOrderDetails(orderId) {
        try {
          const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
          if (!authToken) {
            throw new Error('ç”¨æˆ·æœªç™»å½•');
          }

          const response = await fetch(`http://1.94.203.175:5000/api/order/${orderId}`, {
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            throw new Error('è·å–è®¢å•è¯¦æƒ…å¤±è´¥');
          }

          const result = await response.json();

          if (result.success && result.data) {
            const order = result.data;

            // æ˜¾ç¤ºè®¢å•è¯¦æƒ…
            document.getElementById('orderDetails').innerHTML = `
              <div class="row mb-2">
                <div class="col-4">è®¢å•ç¼–å·ï¼š</div>
                <div class="col-8">${order.orderNumber}</div>
              </div>
              <div class="row mb-2">
                <div class="col-4">ä¸‹å•æ—¶é—´ï¼š</div>
                <div class="col-8">${new Date(order.createdAt).toLocaleString('zh-CN')}</div>
              </div>
              <div class="row mb-2">
                <div class="col-4">è®¢å•çŠ¶æ€ï¼š</div>
                <div class="col-8">${getOrderStatusText(order.status)}</div>
              </div>
              <div class="row mb-2">
                <div class="col-4">è®¢å•é‡‘é¢ï¼š</div>
                <div class="col-8">Â¥${order.totalAmount.toFixed(2)}</div>
              </div>
              <div class="row mb-2">
                <div class="col-4">æ”¶è´§ä¿¡æ¯ï¼š</div>
                <div class="col-8">${order.shippingName} - ${order.shippingPhone}</div>
              </div>
              <div class="row mb-2">
                <div class="col-4">æ”¶è´§åœ°å€ï¼š</div>
                <div class="col-8">${order.shippingAddress}</div>
              </div>
            `;
          } else {
            throw new Error(result.message || 'è·å–è®¢å•è¯¦æƒ…å¤±è´¥');
          }
        } catch (error) {
          console.error('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥:', error);

          // å¦‚æœè·å–è®¢å•è¯¦æƒ…å¤±è´¥ï¼Œå°è¯•ä»localStorageè·å–åŸºæœ¬ä¿¡æ¯
          const orderNumber = localStorage.getItem('lastOrderNumber');
          const orderAmount = localStorage.getItem('lastOrderAmount');

          if (orderNumber && orderAmount) {
            document.getElementById('orderDetails').innerHTML = `
              <div class="row mb-2">
                <div class="col-4">è®¢å•ç¼–å·ï¼š</div>
                <div class="col-8">${orderNumber}</div>
              </div>
              <div class="row mb-2">
                <div class="col-4">ä¸‹å•æ—¶é—´ï¼š</div>
                <div class="col-8">${new Date().toLocaleString('zh-CN')}</div>
              </div>
              <div class="row mb-2">
                <div class="col-4">è®¢å•çŠ¶æ€ï¼š</div>
                <div class="col-8">å¾…æ”¯ä»˜</div>
              </div>
              <div class="row mb-2">
                <div class="col-4">è®¢å•é‡‘é¢ï¼š</div>
                <div class="col-8">Â¥${orderAmount}</div>
              </div>
            `;

            // æ¸…é™¤ä¸´æ—¶å­˜å‚¨
            localStorage.removeItem('lastOrderNumber');
            localStorage.removeItem('lastOrderAmount');
          } else {
            document.getElementById('orderDetails').innerHTML = `
              <div class="text-danger">æ— æ³•è·å–è®¢å•è¯¦æƒ…ï¼Œè¯·ç¨ååœ¨è®¢å•åˆ—è¡¨ä¸­æŸ¥çœ‹ã€‚</div>
            `;
          }
        }
      }

      // æ˜¾ç¤ºé‚®ä»¶å‘é€çŠ¶æ€
      function showEmailStatus(emailSent) {
        const emailStatus = document.getElementById('emailStatus');
        const emailStatusContent = document.getElementById('emailStatusContent');

        if (emailSent === 'true') {
          emailStatusContent.innerHTML = `
            <div class="text-success">
              <i class="mdi mdi-email-check" style="font-size: 2rem;"></i>
              <h6 class="mt-2">ğŸ“§ è®¢å•ç¡®è®¤é‚®ä»¶å·²å‘é€</h6>
              <p class="mb-0">æˆ‘ä»¬å·²å‘æ‚¨çš„é‚®ç®±å‘é€äº†è¯¦ç»†çš„è®¢å•ç¡®è®¤é‚®ä»¶ï¼Œè¯·æ³¨æ„æŸ¥æ”¶ã€‚</p>
            </div>
          `;
          emailStatus.style.display = 'block';
        } else if (emailSent === 'false') {
          emailStatusContent.innerHTML = `
            <div class="text-warning">
              <i class="mdi mdi-email-alert" style="font-size: 2rem;"></i>
              <h6 class="mt-2">âš ï¸ é‚®ä»¶å‘é€å¤±è´¥</h6>
              <p class="mb-0">è®¢å•ç¡®è®¤é‚®ä»¶å‘é€é‡åˆ°é—®é¢˜ï¼Œä½†æ‚¨çš„è®¢å•å·²æˆåŠŸæäº¤ã€‚æ‚¨å¯ä»¥åœ¨è®¢å•å†å²ä¸­æŸ¥çœ‹è¯¦æƒ…ã€‚</p>
            </div>
          `;
          emailStatus.style.display = 'block';
        }
      }

      // è·å–è®¢å•çŠ¶æ€æ–‡æœ¬
      function getOrderStatusText(status) {
        const statusMap = {
          'pending': 'å¾…æ”¯ä»˜',
          'paid': 'å·²æ”¯ä»˜',
          'shipped': 'å·²å‘è´§',
          'delivered': 'å·²é€è¾¾',
          'cancelled': 'å·²å–æ¶ˆ'
        };
        return statusMap[status] || status;
      }

      // è·å–æ”¯ä»˜æ–¹å¼æ–‡æœ¬
      function getPaymentMethodText(method) {
        const methods = {
          'alipay': 'æ”¯ä»˜å®',
          'wechat': 'å¾®ä¿¡æ”¯ä»˜',
          'bankTransfer': 'é“¶è¡Œè½¬è´¦'
        };
        return methods[method] || method;
      }
    </script>
  </body>
</html> 