<!DOCTYPE html>
<html class="wide wow-animation" lang="zh-CN">
  <head>
    <!-- ç½‘ç«™æ ‡é¢˜-->
    <title>ç”¨æˆ·æ³¨å†Œ - åè½©ä¹¦åº—</title>
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <!-- æ ·å¼è¡¨-->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:700%7CLato:300,400,300italic,700">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fonts.css">

    <!-- æ³¨å†Œé¡µé¢ä¸“ç”¨æ ·å¼ -->
    <style>
      /* ä¿®å¤æµ®åŠ¨æ ‡ç­¾é‡åˆé—®é¢˜ */
      .form-wrap {
        position: relative;
        margin-bottom: 25px;
      }

      .form-label {
        position: absolute;
        left: 15px;
        top: 15px;
        font-size: 16px;
        color: #666;
        pointer-events: none;
        transition: all 0.3s ease;
        background: #f8f9fa;
        padding: 0 5px;
        z-index: 1;
      }

      /* å½“è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æˆ–æœ‰å†…å®¹æ—¶ï¼Œæ ‡ç­¾ä¸Šç§» */
      .form-input:focus + .form-label,
      .form-input:not(:placeholder-shown) + .form-label,
      .form-input.has-value + .form-label {
        top: -8px;
        left: 10px;
        font-size: 12px;
        color: #007bff;
        background: white;
      }

      /* ç¡®ä¿è¾“å…¥æ¡†æœ‰å†…å®¹æ—¶æ ‡ç­¾ä¿æŒä¸Šç§»çŠ¶æ€ */
      .form-input:valid + .form-label {
        top: -8px;
        left: 10px;
        font-size: 12px;
        color: #007bff;
        background: white;
      }

      /* è¾“å…¥æ¡†æ ·å¼ä¼˜åŒ– */
      .form-input {
        position: relative;
        z-index: 0;
      }

      .form-input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
      }
    </style>
		<!--[if lt IE 10]>
    <div style="background: #212121; padding: 10px 0; box-shadow: 3px 3px 5px 0 rgba(0,0,0,.3); clear: both; text-align:center; position: relative; z-index:1;"><a href="http://windows.microsoft.com/en-US/internet-explorer/"><img src="images/ie8-panel/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="æ‚¨æ­£åœ¨ä½¿ç”¨è¿‡æ—¶çš„æµè§ˆå™¨ã€‚ä¸ºäº†è·å¾—æ›´å¿«æ›´å®‰å…¨çš„æµè§ˆä½“éªŒï¼Œè¯·å…è´¹å‡çº§ã€‚"></a></div>
    <script src="js/html5shiv.min.js"></script>
		<![endif]-->
  </head>
  <body>
    <!-- Page preloader-->
    <div class="page-loader">
      <div class="page-loader-body">
        <div class="preloader-wrapper big active">
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"> </div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Page-->
    <div class="page">
      <!-- Page Header-->
      <header class="section page-header">
        <!-- RD Navbar-->
        <div class="rd-navbar-wrap rd-navbar-centered">
          <nav class="rd-navbar novi-background" data-layout="rd-navbar-fixed" data-sm-layout="rd-navbar-fixed" data-md-layout="rd-navbar-fixed" data-md-device-layout="rd-navbar-fixed" data-lg-layout="rd-navbar-fullwidth" data-lg-device-layout="rd-navbar-fixed" data-xl-layout="rd-navbar-static" data-xl-device-layout="rd-navbar-static" data-md-stick-up-offset="1px" data-lg-stick-up-offset="1px" data-stick-up="true" data-sm-stick-up="true" data-md-stick-up="true" data-lg-stick-up="true" data-xl-stick-up="true">
            <div class="rd-navbar-inner">
              <div class="rd-navbar-aside-left">
                <div class="rd-navbar-nav-wrap">
                  <!-- RD Navbar Nav-->
                  <ul class="rd-navbar-nav">
                    <li><a href="index.html">é¦–é¡µ</a></li>
                    <li><a href="#">å›¾ä¹¦åˆ†ç±»</a>
                      <!-- RD Navbar Dropdown-->
                      <ul class="rd-navbar-dropdown">
                        <li><a href="category.html?type=literature">æ–‡å­¦è‰ºæœ¯</a></li>
                        <li><a href="category.html?type=education">æ•™è‚²è€ƒè¯•</a></li>
                        <li><a href="category.html?type=children">å°‘å„¿è¯»ç‰©</a></li>
                        <li><a href="category.html?type=technology">ç§‘æŠ€è®¡ç®—æœº</a></li>
                        <li><a href="category.html?type=life">ç”Ÿæ´»ä¼‘é—²</a></li>
                        <li><a href="category.html?type=social">ç¤¾ä¼šç§‘å­¦</a></li>
                      </ul>
                    </li>
                    <li><a href="recommendations.html">ä¸ºæ‚¨æ¨è</a></li>
                    <li><a href="forum.html">è¯»è€…è®ºå›</a></li>
                  </ul>
                </div>
              </div>
              <!-- RD Navbar Panel-->
              <div class="rd-navbar-panel">
                <!-- RD Navbar Toggle-->
                <button class="rd-navbar-toggle" data-rd-navbar-toggle=".rd-navbar-nav-wrap"><span></span></button>
                <!-- RD Navbar Brand-->
                <div class="rd-navbar-brand">
                  <a class="brand-name" href="index.html">
                    <img class="logo-default" src="images/logo-default-161x57.png" alt="åè½©ä¹¦åº—" width="161" height="57"/>
                    <img class="logo-inverse" src="images/logo-inverse-161x57.png" alt="åè½©ä¹¦åº—" width="161" height="57"/>
                  </a>
                </div>
              </div>
              <div class="rd-navbar-collapse-toggle" data-rd-navbar-toggle=".rd-navbar-collapse"><span></span></div>
              <div class="rd-navbar-aside-right rd-navbar-collapse">
                <!-- RD Navbar Search-->
                <div class="rd-navbar-search">
                  <a class="rd-navbar-search-toggle" data-rd-navbar-toggle=".rd-navbar-search" href="#"><span></span></a>
                  <form class="rd-search" action="search.html" data-search-live="rd-search-results-live" method="GET">
                    <div class="form-wrap">
                      <label class="form-label form-label" for="rd-navbar-search-form-input">æœç´¢å›¾ä¹¦...</label>
                      <input class="rd-navbar-search-form-input form-input" id="rd-navbar-search-form-input" type="text" name="keyword" autocomplete="off">
                      <div class="rd-search-results-live"></div>
                    </div>
                    <button class="rd-search-form-submit mdi mdi-magnify"></button>
                  </form>
                </div>
                <!-- User Menu -->
                <div class="rd-navbar-user">
                  <a href="login-page.html" class="user-icon" id="userMenu">
                    <i class="mdi mdi-account"></i>
                    <span id="userDisplayName">ç™»å½•</span>
                  </a>
                  <div class="user-dropdown" id="userDropdown" style="display: none;">
                    <a href="user-profile.html">ä¸ªäººèµ„æ–™</a>
                    <a href="order-history.html">æˆ‘çš„è®¢å•</a>
                    <a href="browsing-history.html">æµè§ˆå†å²</a>
                    <a href="user-preferences.html">åå¥½è®¾ç½®</a>
                    <a href="change-password.html">ä¿®æ”¹å¯†ç </a>
                    <a href="#" onclick="logout()">é€€å‡ºç™»å½•</a>
                  </div>
                </div>
                <!-- Shopping Cart -->
                <div class="rd-navbar-cart">
                  <a href="shopping-cart.html" class="cart-icon" id="cartIcon">
                    <i class="mdi mdi-cart"></i>
                    <span class="cart-count" id="cartCount">0</span>
                  </a>
                </div>
              </div>
            </div>
          </nav>
        </div>
      </header>
      <section class="single-screen section fullwidth-page">
        <div class="fullwidth-page-inner" style="display: flex; align-items: flex-start; justify-content: center; min-height: 100vh; padding-top: 90px;">
          <div class="section-md" style="width: 100%;">
            <div class="container">
              <div class="row">
                <div class="col-md-10 col-lg-8 col-xl-6" style="margin-left: 35%;">
                  <div class="card" style="padding: 60px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
                    <h3 class="text-primary mb-4" style="margin-bottom: 40px; font-size: 28px;">ç”¨æˆ·æ³¨å†Œ</h3>
                    <!-- RD Mailform-->
                    <form class="rd-mailform form-fix" id="registrationForm" method="POST" action="#" style="margin-top: 30px;">
                      <div class="form-wrap form-wrap-validation">
                        <input class="form-input" id="form-username" type="text" name="username" data-constraints="@Required" style="background: #f8f9fa; font-size: 16px; padding: 15px;">
                        <label class="form-label" for="form-username">ç”¨æˆ·å</label>
                      </div>
                      <div class="form-wrap form-wrap-validation">
                        <input class="form-input" id="form-email" type="email" name="email" data-constraints="@Email @Required" style="background: #f8f9fa; font-size: 16px; padding: 15px;">
                        <label class="form-label" for="form-email">ç”µå­é‚®ç®±</label>
                      </div>
                      <div class="form-wrap form-wrap-validation">
                        <input class="form-input" id="form-password" type="password" name="password" data-constraints="@Required" style="background: #f8f9fa; font-size: 16px; padding: 15px;">
                        <label class="form-label" for="form-password">å¯†ç </label>
                      </div>
                      <div class="form-wrap form-wrap-validation">
                        <input class="form-input" id="form-confirm-password" type="password" name="confirmPassword" data-constraints="@Required" style="background: #f8f9fa; font-size: 16px; padding: 15px;">
                        <label class="form-label" for="form-confirm-password">ç¡®è®¤å¯†ç </label>
                      </div>
                      <div class="form-wrap form-wrap-validation">
                        <input class="form-input" id="form-phone" type="tel" name="phone" data-constraints="@Required @Numeric" style="background: #f8f9fa; font-size: 16px; padding: 15px;">
                        <label class="form-label" for="form-phone">æ‰‹æœºå·ç </label>
                      </div>
                      <div class="form-wrap text-left">
                        <div class="checkbox-inline">
                          <label class="checkbox-inline__label" style="font-size: 16px;">
                            <input class="checkbox-inline__input" type="checkbox" name="agreement" value="yes" data-constraints="@Required">
                            <span class="checkbox-inline__box"></span>æˆ‘å·²é˜…è¯»å¹¶åŒæ„<a href="terms.html">æœåŠ¡æ¡æ¬¾</a>å’Œ<a href="privacy.html">éšç§æ”¿ç­–</a>
                          </label>
                        </div>
                      </div>
                      <div class="form-wrap">
                        <button class="button button-block button-primary" type="submit" style="font-size: 18px; padding: 15px;">æ³¨å†Œ</button>
                      </div>
                      <div class="form-wrap text-center" style="margin-top: 25px;">
                        <p style="font-size: 16px;">å·²æœ‰è´¦å·ï¼Ÿ <a href="login-page.html">ç«‹å³ç™»å½•</a></p>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="fullwidth-page-footer text-center">
          <p class="rights"><span>&copy;&nbsp;</span><span class="copyright-year"></span><span>&nbsp;</span><span>åè½©ä¹¦åº—</span><span>. ä¿ç•™æ‰€æœ‰æƒåˆ©.</span></p>
        </div>
      </section>
    </div>
    <!-- Global Mailform Output-->
    <div class="snackbars" id="form-output-global"></div>
    <!-- Javascript-->
    <script src="js/core.min.js"></script>
    <script src="js/script.js"></script>
    <!-- Registration specific scripts -->
    <script>
      // é‚®ä»¶æœåŠ¡APIé…ç½®
      const EMAIL_API_BASE = 'http://1.94.203.175:5000/api/email';

      // å¤„ç†æµ®åŠ¨æ ‡ç­¾
      function handleFloatingLabels() {
        const inputs = document.querySelectorAll('.form-input');
        inputs.forEach(input => {
          // æ£€æŸ¥è¾“å…¥æ¡†æ˜¯å¦æœ‰å€¼
          function checkValue() {
            if (input.value.trim() !== '') {
              input.classList.add('has-value');
            } else {
              input.classList.remove('has-value');
            }
          }

          // åˆå§‹æ£€æŸ¥
          checkValue();

          // ç›‘å¬è¾“å…¥äº‹ä»¶
          input.addEventListener('input', checkValue);
          input.addEventListener('change', checkValue);
          input.addEventListener('blur', checkValue);
        });
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ“„ æ³¨å†Œé¡µé¢DOMåŠ è½½å®Œæˆ');

        handleFloatingLabels();

        // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶ - ä½¿ç”¨æ›´å¼ºåˆ¶çš„æ–¹å¼
        setTimeout(() => {
          const registrationForm = document.getElementById('registrationForm');
          console.log('ğŸ” æŸ¥æ‰¾æ³¨å†Œè¡¨å•:', registrationForm);

          if (registrationForm) {
            console.log('âœ… æ‰¾åˆ°æ³¨å†Œè¡¨å•ï¼Œç»‘å®šæäº¤äº‹ä»¶');

            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
            registrationForm.removeEventListener('submit', handleFormSubmit);

            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            registrationForm.addEventListener('submit', handleFormSubmit);

            // åŒæ—¶ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶ä½œä¸ºå¤‡ç”¨
            const submitButton = registrationForm.querySelector('button[type="submit"]');
            if (submitButton) {
              console.log('âœ… æ‰¾åˆ°æäº¤æŒ‰é’®ï¼Œç»‘å®šç‚¹å‡»äº‹ä»¶');
              submitButton.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('ğŸ–±ï¸ æäº¤æŒ‰é’®è¢«ç‚¹å‡»');
                handleFormSubmit(e);
              });
            }

          } else {
            console.error('âŒ æœªæ‰¾åˆ°æ³¨å†Œè¡¨å•å…ƒç´ ');
            // å°è¯•æŸ¥æ‰¾æ‰€æœ‰è¡¨å•
            const allForms = document.querySelectorAll('form');
            console.log('ğŸ“‹ é¡µé¢ä¸­æ‰€æœ‰è¡¨å•:', allForms);
          }
        }, 500); // å»¶è¿Ÿ500msç¡®ä¿DOMå®Œå…¨åŠ è½½
      });

      // è¡¨å•æäº¤å¤„ç†å‡½æ•°
      function handleFormSubmit(e) {
        e.preventDefault();
        console.log('ğŸ“ æ³¨å†Œè¡¨å•æäº¤äº‹ä»¶è§¦å‘');

        const username = document.getElementById('form-username')?.value || '';
        const email = document.getElementById('form-email')?.value || '';
        const password = document.getElementById('form-password')?.value || '';
        const confirmPassword = document.getElementById('form-confirm-password')?.value || '';
        const phone = document.getElementById('form-phone')?.value || '';
        const agreement = document.querySelector('input[name="agreement"]')?.checked || false;

        console.log('ğŸ“‹ è¡¨å•æ•°æ®:', { username, email, phone, agreement });

        // è¡¨å•éªŒè¯
        if (!username || !email || !password) {
          showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
          return;
        }

        if (password !== confirmPassword) {
          showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
          return;
        }

        if (!agreement) {
          showMessage('è¯·é˜…è¯»å¹¶åŒæ„æœåŠ¡æ¡æ¬¾å’Œéšç§æ”¿ç­–', 'error');
          return;
        }

        // è°ƒç”¨æ³¨å†ŒAPI
        console.log('ğŸš€ å¼€å§‹è°ƒç”¨æ³¨å†ŒAPI');
        handleRegistration(username, email, password, phone);
      }

      // å¤„ç†æ³¨å†Œ
      async function handleRegistration(username, email, password, phone) {
        const output = document.getElementById('form-output-global');

        try {
          // æ˜¾ç¤ºæ³¨å†Œä¸­æ¶ˆæ¯
          output.innerHTML = '<div class="alert alert-info">æ­£åœ¨æ³¨å†Œ...</div>';
          output.style.display = 'block';

          // è°ƒç”¨æ³¨å†ŒAPI
          const response = await fetch('http://1.94.203.175:5000/api/user/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              username: username,
              email: email,
              password: password,
              phone: phone,
              realName: username
            })
          });

          const result = await response.json();
          console.log('ğŸ”„ æ³¨å†Œå“åº”:', result);

          if (result.success) {
            // æ³¨å†ŒæˆåŠŸï¼Œä¿å­˜ç™»å½•çŠ¶æ€
            localStorage.setItem('authToken', result.data.token);
            localStorage.setItem('token', result.data.token); // å…¼å®¹æ€§
            localStorage.setItem('userInfo', JSON.stringify(result.data.user));
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('username', result.data.user.username);
            localStorage.setItem('userEmail', result.data.user.email);

            console.log('âœ… æ³¨å†ŒæˆåŠŸï¼Œå·²ä¿å­˜ç™»å½•çŠ¶æ€:', {
              authToken: !!result.data.token,
              userInfo: result.data.user,
              isLoggedIn: 'true'
            });

            // å¤„ç†åç»­æµç¨‹
            handleRegistrationSuccess(username, email);
          } else {
            // æ³¨å†Œå¤±è´¥
            output.innerHTML = `<div class="alert alert-danger">æ³¨å†Œå¤±è´¥: ${result.message}</div>`;
            output.style.display = 'block';
          }
        } catch (error) {
          console.error('âŒ æ³¨å†Œé”™è¯¯:', error);
          output.innerHTML = `<div class="alert alert-danger">æ³¨å†Œå¤±è´¥: ${error.message}</div>`;
          output.style.display = 'block';
        }
      }

      // å¤„ç†æ³¨å†ŒæˆåŠŸ
      async function handleRegistrationSuccess(username, email) {
        const output = document.getElementById('form-output-global');

        // æ˜¾ç¤ºæ³¨å†ŒæˆåŠŸæ¶ˆæ¯
        output.innerHTML = `<div class="alert alert-success">ğŸ‰ æ³¨å†ŒæˆåŠŸï¼æ¬¢è¿ ${username}ï¼å·²è‡ªåŠ¨ç™»å½•ï¼Œæ­£åœ¨è·³è½¬åˆ°é¦–é¡µ...</div>`;
        output.style.display = 'block';

        console.log('âœ… æ³¨å†ŒæˆåŠŸï¼Œå‡†å¤‡è·³è½¬åˆ°é¦–é¡µ');

        // å¼‚æ­¥å‘é€æ¬¢è¿é‚®ä»¶ï¼ˆä¸é˜»å¡è·³è½¬ï¼‰
        sendWelcomeEmail(username, email).then(() => {
          console.log('âœ… æ¬¢è¿é‚®ä»¶å‘é€æˆåŠŸ');
        }).catch(error => {
          console.error('âŒ æ¬¢è¿é‚®ä»¶å‘é€å¤±è´¥:', error);
          // é‚®ä»¶å‘é€å¤±è´¥ä¸å½±å“æ³¨å†Œæµç¨‹
        });

        // 3ç§’åè·³è½¬åˆ°é¦–é¡µ
        setTimeout(() => {
          console.log('ğŸ”„ æ­£åœ¨è·³è½¬åˆ°é¦–é¡µ...');
          window.location.href = 'index.html';
        }, 3000);
      }

      // å‘é€æ¬¢è¿é‚®ä»¶
      async function sendWelcomeEmail(username, email) {
        try {
          const response = await fetch(`${EMAIL_API_BASE}/send`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email: email,
              email_type: 'welcome',
              username: username,
              user_id: null
            })
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'é‚®ä»¶å‘é€å¤±è´¥');
          }

          console.log('âœ… æ¬¢è¿é‚®ä»¶å‘é€æˆåŠŸ');
          return data;

        } catch (error) {
          console.error('âŒ å‘é€æ¬¢è¿é‚®ä»¶æ—¶å‡ºé”™:', error);
          throw error;
        }
      }

      // æ˜¾ç¤ºæ¶ˆæ¯çš„è¾…åŠ©å‡½æ•°
      function showMessage(message, type = 'info') {
        const output = document.getElementById('form-output-global');
        const alertClass = type === 'success' ? 'alert-success' :
                          type === 'error' ? 'alert-danger' :
                          type === 'warning' ? 'alert-warning' : 'alert-info';

        output.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        output.style.display = 'block';
      }
    </script>
  </body>
</html>