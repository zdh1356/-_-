<!DOCTYPE html>
<html class="wide wow-animation" lang="zh-CN">
  <head>
    <title>ä¸ºæ‚¨æ¨è - åè½©ä¹¦åº—</title>
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <!-- Stylesheets-->
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Montserrat:400,500,600,700%7CPoppins:400%7CTeko:300,400">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/fonts.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
      .ie-panel{display: none;background: #212121;padding: 10px 0;box-shadow: 3px 3px 5px 0 rgba(0,0,0,.3);clear: both;text-align:center;position: relative;z-index: 1;} html.ie-10 .ie-panel, html.lt-ie-10 .ie-panel {display: block;}
    </style>
  </head>
  <body>
    <div class="ie-panel"><a href="http://windows.microsoft.com/en-US/internet-explorer/"><img src="images/ie8-panel/warning_bar_0000_us.jpg" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today."></a></div>
    <div class="preloader">
      <div class="preloader-body">
        <div class="cssload-container">
          <div class="cssload-speeding-wheel"></div>
        </div>
        <p>Loading...</p>
      </div>
    </div>
    <!-- Page-->
    <div class="page">
      <!-- Page Header-->
      <header class="section page-header">
        <!-- RD Navbar-->
        <div class="rd-navbar-wrap rd-navbar-centered">
          <nav class="rd-navbar novi-background" data-layout="rd-navbar-fixed" data-sm-layout="rd-navbar-fixed" data-md-layout="rd-navbar-fixed" data-md-device-layout="rd-navbar-fixed" data-lg-layout="rd-navbar-fullwidth" data-lg-device-layout="rd-navbar-fixed" data-xl-layout="rd-navbar-static" data-xl-device-layout="rd-navbar-static" data-md-stick-up-offset="1px" data-lg-stick-up-offset="1px" data-stick-up="true" data-sm-stick-up="true" data-md-stick-up="true" data-lg-stick-up="true" data-xl-stick-up="true">
            <div class="rd-navbar-inner">
              <div class="rd-navbar-aside-left">
                <div class="rd-navbar-nav-wrap">
                  <!-- RD Navbar Nav-->
                  <ul class="rd-navbar-nav">
                    <li><a href="index.html">é¦–é¡µ</a></li>
                    <li><a href="#">å›¾ä¹¦åˆ†ç±»</a>
                      <!-- RD Navbar Dropdown-->
                      <ul class="rd-navbar-dropdown">
                        <li><a href="category.html?type=business">å•†ä¸šç®¡ç†</a></li>
                        <li><a href="category.html?type=technology">ç§‘æŠ€è®¡ç®—æœº</a></li>
                        <li><a href="category.html?type=literature">æ–‡å­¦è‰ºæœ¯</a></li>
                        <li><a href="category.html?type=education">æ•™è‚²è€ƒè¯•</a></li>
                        <li><a href="category.html?type=children">å°‘å„¿è¯»ç‰©</a></li>
                        <li><a href="category.html?type=life">ç”Ÿæ´»ä¼‘é—²</a></li>
                        <li><a href="category.html?type=social">ç¤¾ä¼šç§‘å­¦</a></li>
                      </ul>
                    </li>
                    <li class="active"><a href="recommendations.html">ä¸ºæ‚¨æ¨è</a></li>
                    <li><a href="forum.html">è¯»è€…è®ºå›</a></li>
                  </ul>
                </div>
              </div>
              <!-- RD Navbar Panel-->
              <div class="rd-navbar-panel">
                <button class="rd-navbar-toggle" data-rd-navbar-toggle=".rd-navbar-nav-wrap"><span></span></button>
                <!-- RD Navbar Brand-->
                <div class="rd-navbar-brand"><a class="brand-name" href="index.html"><img class="logo-default" src="images/logo-default-161x57.png" alt="åè½©ä¹¦åº—" width="161" height="57"/><img class="logo-inverse" src="images/logo-inverse-161x57.png" alt="åè½©ä¹¦åº—" width="161" height="57"/></a></div>
              </div>
              <div class="rd-navbar-collapse-toggle" data-rd-navbar-toggle=".rd-navbar-collapse"><span></span></div>
              <div class="rd-navbar-aside-right rd-navbar-collapse">
                <!-- RD Navbar Search-->
                <div class="rd-navbar-search"><a class="rd-navbar-search-toggle" data-rd-navbar-toggle=".rd-navbar-search" href="#"><span></span></a>
                  <form class="rd-search" action="search-results.html" data-search-live="rd-search-results-live" method="GET">
                    <div class="form-wrap">
                      <label class="form-label form-label" for="rd-navbar-search-form-input">æœç´¢å›¾ä¹¦...</label>
                      <input class="rd-navbar-search-form-input form-input" id="rd-navbar-search-form-input" type="text" name="keyword" autocomplete="off">
                      <div class="rd-search-results-live"></div>
                    </div>
                    <button class="rd-search-form-submit mdi mdi-magnify"></button>
                  </form>
                </div>
                <!-- User Menu -->
                <div class="rd-navbar-user">
                  <a href="login-page.html" class="user-icon" id="userMenu">
                    <i class="mdi mdi-account"></i>
                    <span id="userDisplayName">ç™»å½•</span>
                  </a>
                  <div class="user-dropdown" id="userDropdown" style="display: none;">
                    <a href="user-profile.html">ä¸ªäººèµ„æ–™</a>
                    <a href="order-history.html">æˆ‘çš„è®¢å•</a>
                    <a href="browsing-history.html">æµè§ˆå†å²</a>
                    <a href="user-preferences.html">åå¥½è®¾ç½®</a>
                    <a href="change-password.html">ä¿®æ”¹å¯†ç </a>
                    <a href="#" onclick="logout()">é€€å‡ºç™»å½•</a>
                  </div>
                </div>
                <!-- Shopping Cart -->
                <div class="rd-navbar-cart">
                  <a href="shopping-cart.html" class="cart-icon" id="cartIcon">
                    <i class="mdi mdi-cart"></i>
                    <span class="cart-count" id="cartCount">0</span>
                  </a>
                </div>
              </div>
            </div>
          </nav>
        </div>
      </header>

      <!-- Breadcrumbs-->
      <section class="breadcrumbs-custom" style="background-image: url(images/breadcrumbs-bg.jpg)">
        <div class="container">
          <p class="breadcrumbs-custom-subtitle">ä¸ªæ€§åŒ–æœåŠ¡</p>
          <p class="heading-1 breadcrumbs-custom-title">ä¸ºæ‚¨æ¨è</p>
          <ul class="breadcrumbs-custom-path">
            <li><a href="index.html">é¦–é¡µ</a></li>
            <li class="active">ä¸ºæ‚¨æ¨è</li>
          </ul>
        </div>
      </section>

      <!-- Recommendations Section -->
      <section class="section section-lg bg-default">
        <div class="container">
          <!-- User Preference Summary -->
          <div class="card mb-4" id="preferenceSummary">
            <div class="card-header">
              <h4>ğŸ¯ æ‚¨çš„é˜…è¯»åå¥½</h4>
            </div>
            <div class="card-body">
              <div id="preferenceContent">
                <!-- åå¥½å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
              </div>
            </div>
          </div>

          <!-- Recommendation Tabs -->
          <div class="recommendation-tabs">
            <ul class="nav nav-tabs" id="recommendationTabs">
              <li class="nav-item">
                <a class="nav-link active" data-tab="browsing" href="#browsing">åŸºäºæµè§ˆå†å²</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-tab="purchase" href="#purchase">åŸºäºè´­ä¹°å†å²</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-tab="similar" href="#similar">ç›¸ä¼¼ç”¨æˆ·æ¨è</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-tab="popular" href="#popular">çƒ­é—¨æ¨è</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-tab="new" href="#new">æ–°ä¹¦æ¨è</a>
              </li>
            </ul>
          </div>

          <!-- Recommendation Content -->
          <div class="tab-content" id="recommendationContent">
            <!-- æ¨èå†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
          </div>

          <!-- Recommendation Settings -->
          <div class="card mt-4">
            <div class="card-header">
              <h5>âš™ï¸ æ¨èè®¾ç½®</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4">
                  <div class="form-group">
                    <label>æ¨èç®—æ³•</label>
                    <select id="algorithmSelect" class="form-control">
                      <option value="browsing">åŸºäºæµè§ˆå†å²</option>
                      <option value="purchase">åŸºäºè´­ä¹°å†å²</option>
                      <option value="similar">ç›¸ä¼¼ç”¨æˆ·æ¨è</option>
                      <option value="popular">çƒ­é—¨å›¾ä¹¦æ¨è</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label>æ¨èæ•°é‡</label>
                    <select id="countSelect" class="form-control">
                      <option value="6">6æœ¬å›¾ä¹¦</option>
                      <option value="12" selected>12æœ¬å›¾ä¹¦</option>
                      <option value="24">24æœ¬å›¾ä¹¦</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label>åˆ†ç±»è¿‡æ»¤</label>
                    <select id="categoryFilter" class="form-control">
                      <option value="">å…¨éƒ¨åˆ†ç±»</option>
                      <option value="literature">æ–‡å­¦è‰ºæœ¯</option>
                      <option value="technology">ç§‘æŠ€è®¡ç®—æœº</option>
                      <option value="business">ç»æµç®¡ç†</option>
                      <option value="education">æ•™è‚²è€ƒè¯•</option>
                      <option value="children">å°‘å„¿è¯»ç‰©</option>
                      <option value="life">ç”Ÿæ´»ä¼‘é—²</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="text-center">
                <div class="button-group">
                  <button class="btn btn-primary" onclick="updateRecommendations()">æ›´æ–°æ¨è</button>
                  <button class="btn btn-secondary" onclick="refreshRecommendations()">åˆ·æ–°æ¨è</button>
                  <button class="btn btn-outline-primary" onclick="sendRecommendationEmail()">ğŸ“§ å‘é€æ¨èé‚®ä»¶</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Global Mailform Output-->
    <div class="snackbars" id="form-output-global"></div>
    <!-- Javascript-->
    <script src="js/core.min.js"></script>
    <script src="js/script.js"></script>

    <!-- Recommendations Scripts -->
    <script>
      // é‚®ä»¶æœåŠ¡APIé…ç½®
      const EMAIL_API_BASE = 'http://1.94.203.175:5000/api/email';

      // æ¨¡æ‹Ÿæ¨èå›¾ä¹¦æ•°æ®åº“
      const recommendationDatabase = {
        browsing: [
          {
            id: 10,
            title: 'æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ',
            author: 'Randal E. Bryant',
            publisher: 'æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾',
            price: 139.00,
            originalPrice: 159.00,
            stock: 25,
            category: 'technology',
            cover: 'images/book-06-188x246.jpg',
            reason: 'åŸºäºæ‚¨å¯¹æŠ€æœ¯ç±»å›¾ä¹¦çš„æµè§ˆåå¥½',
            score: 95
          },
          {
            id: 11,
            title: 'JavaScripté«˜çº§ç¨‹åºè®¾è®¡',
            author: 'Nicholas C. Zakas',
            publisher: 'äººæ°‘é‚®ç”µå‡ºç‰ˆç¤¾',
            price: 99.00,
            originalPrice: 119.00,
            stock: 42,
            category: 'technology',
            cover: 'images/book-07-188x246.jpg',
            reason: 'ä¸æ‚¨æµè§ˆçš„ã€Šç½‘é¡µè®¾è®¡åŸºç¡€ã€‹ç›¸å…³',
            score: 92
          },
          {
            id: 12,
            title: 'è®¾è®¡å¿ƒç†å­¦',
            author: 'å”çº³å¾·Â·è¯ºæ›¼',
            publisher: 'ä¸­ä¿¡å‡ºç‰ˆç¤¾',
            price: 49.00,
            originalPrice: 59.00,
            stock: 38,
            category: 'business',
            cover: 'images/book-08-188x246.jpg',
            reason: 'ä¸æ‚¨æµè§ˆçš„ã€Šé¢†å¯¼åŠ›è‰ºæœ¯ã€‹ç›¸å…³',
            score: 88
          }
        ],
        purchase: [
          {
            id: 13,
            title: 'äººç±»ç®€å²',
            author: 'å°¤ç“¦å°”Â·èµ«æ‹‰åˆ©',
            publisher: 'ä¸­ä¿¡å‡ºç‰ˆç¤¾',
            price: 68.00,
            originalPrice: 78.00,
            stock: 56,
            category: 'social',
            cover: 'images/book-09-188x246.jpg',
            reason: 'è´­ä¹°è¿‡æ–‡å­¦ç±»å›¾ä¹¦çš„ç”¨æˆ·ä¹Ÿå–œæ¬¢',
            score: 94
          },
          {
            id: 14,
            title: 'æœªæ¥ç®€å²',
            author: 'å°¤ç“¦å°”Â·èµ«æ‹‰åˆ©',
            publisher: 'ä¸­ä¿¡å‡ºç‰ˆç¤¾',
            price: 72.00,
            originalPrice: 82.00,
            stock: 33,
            category: 'social',
            cover: 'images/book-10-188x246.jpg',
            reason: 'ä¸æ‚¨è´­ä¹°çš„å›¾ä¹¦é£æ ¼ç›¸ä¼¼',
            score: 91
          }
        ],
        similar: [
          {
            id: 15,
            title: 'ä¸‰ä½“',
            author: 'åˆ˜æ…ˆæ¬£',
            publisher: 'é‡åº†å‡ºç‰ˆç¤¾',
            price: 23.00,
            originalPrice: 29.00,
            stock: 67,
            category: 'literature',
            cover: 'images/book-11-188x246.jpg',
            reason: 'ç›¸ä¼¼ç”¨æˆ·å¼ºçƒˆæ¨è',
            score: 96
          },
          {
            id: 16,
            title: 'é»‘å®¢ä¸ç”»å®¶',
            author: 'Paul Graham',
            publisher: 'äººæ°‘é‚®ç”µå‡ºç‰ˆç¤¾',
            price: 55.00,
            originalPrice: 65.00,
            stock: 29,
            category: 'technology',
            cover: 'images/book-12-188x246.jpg',
            reason: 'ä¸æ‚¨å…´è¶£ç›¸ä¼¼çš„ç”¨æˆ·ä¹Ÿåœ¨çœ‹',
            score: 89
          }
        ],
        popular: [
          {
            id: 17,
            title: 'åŸåˆ™',
            author: 'ç‘Â·è¾¾åˆ©æ¬§',
            publisher: 'ä¸­ä¿¡å‡ºç‰ˆç¤¾',
            price: 98.00,
            originalPrice: 118.00,
            stock: 45,
            category: 'business',
            cover: 'images/book-13-188x246.jpg',
            reason: 'æœ¬æœˆæœ€å—æ¬¢è¿çš„ç®¡ç†ç±»å›¾ä¹¦',
            score: 97
          },
          {
            id: 18,
            title: 'æ€è€ƒï¼Œå¿«ä¸æ…¢',
            author: 'ä¸¹å°¼å°”Â·å¡å°¼æ›¼',
            publisher: 'ä¸­ä¿¡å‡ºç‰ˆç¤¾',
            price: 69.00,
            originalPrice: 79.00,
            stock: 52,
            category: 'social',
            cover: 'images/book-14-188x246.jpg',
            reason: 'å¿ƒç†å­¦ç±»çƒ­é—¨å›¾ä¹¦',
            score: 93
          }
        ],
        new: [
          {
            id: 19,
            title: 'ChatGPTï¼šAIé©å‘½',
            author: 'æå¼€å¤',
            publisher: 'æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾',
            price: 89.00,
            originalPrice: 99.00,
            stock: 78,
            category: 'technology',
            cover: 'images/book-15-188x246.jpg',
            reason: '2024å¹´æœ€æ–°AIæŠ€æœ¯å›¾ä¹¦',
            score: 90,
            isNew: true
          },
          {
            id: 20,
            title: 'æ•°å­—åŒ–è½¬å‹å®æˆ˜',
            author: 'å¼ ä¸‰ä¸°',
            publisher: 'ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾',
            price: 79.00,
            originalPrice: 89.00,
            stock: 34,
            category: 'business',
            cover: 'images/book-16-188x246.jpg',
            reason: 'ä¼ä¸šæ•°å­—åŒ–è½¬å‹å¿…è¯»',
            score: 87,
            isNew: true
          }
        ]
      };

      // åˆ†ç±»åç§°æ˜ å°„
      const categoryNames = {
        'literature': 'æ–‡å­¦è‰ºæœ¯',
        'technology': 'ç§‘æŠ€è®¡ç®—æœº',
        'business': 'ç»æµç®¡ç†',
        'education': 'æ•™è‚²è€ƒè¯•',
        'children': 'å°‘å„¿è¯»ç‰©',
        'life': 'ç”Ÿæ´»ä¼‘é—²',
        'social': 'ç¤¾ä¼šç§‘å­¦'
      };

      let currentTab = 'browsing';

      // æ˜¾ç¤ºç”¨æˆ·åå¥½æ‘˜è¦
      function displayPreferenceSummary() {
        const preferences = JSON.parse(localStorage.getItem('userPreferences') || '{}');
        const browsingHistory = JSON.parse(localStorage.getItem('browsingHistory') || '[]');
        const preferenceContent = document.getElementById('preferenceContent');

        // åˆ†ææµè§ˆåå¥½
        const categoryCount = {};
        browsingHistory.forEach(item => {
          categoryCount[item.category] = (categoryCount[item.category] || 0) + 1;
        });

        const topCategories = Object.keys(categoryCount)
          .sort((a, b) => categoryCount[b] - categoryCount[a])
          .slice(0, 3);

        const preferredCategories = preferences.categories || [];

        const summaryHTML = `
          <div class="preference-summary">
            <div class="row">
              <div class="col-md-4">
                <div class="preference-item">
                  <h6><i class="mdi mdi-heart"></i> åå¥½åˆ†ç±»</h6>
                  <div class="category-tags">
                    ${preferredCategories.map(cat =>
                      `<span class="category-tag">${categoryNames[cat] || cat}</span>`
                    ).join('')}
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="preference-item">
                  <h6><i class="mdi mdi-eye"></i> æµè§ˆåå¥½</h6>
                  <div class="category-tags">
                    ${topCategories.map(cat =>
                      `<span class="browsing-tag">${categoryNames[cat] || cat} (${categoryCount[cat]})</span>`
                    ).join('')}
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="preference-item">
                  <h6><i class="mdi mdi-settings"></i> æ¨èè®¾ç½®</h6>
                  <p>ç®—æ³•: ${getAlgorithmName(preferences.recommendations?.algorithm || 'browsing')}</p>
                  <p>é¢‘ç‡: ${getFrequencyName(preferences.recommendations?.frequency || 'weekly')}</p>
                </div>
              </div>
            </div>
            <div class="text-center mt-3">
              <a href="user-preferences.html" class="btn btn-outline-primary btn-sm">ä¿®æ”¹åå¥½è®¾ç½®</a>
            </div>
          </div>
        `;

        preferenceContent.innerHTML = summaryHTML;
      }

      // è·å–ç®—æ³•åç§°
      function getAlgorithmName(algorithm) {
        const names = {
          'browsing': 'åŸºäºæµè§ˆå†å²',
          'purchase': 'åŸºäºè´­ä¹°å†å²',
          'similar': 'ç›¸ä¼¼ç”¨æˆ·æ¨è',
          'popular': 'çƒ­é—¨å›¾ä¹¦æ¨è'
        };
        return names[algorithm] || algorithm;
      }

      // è·å–é¢‘ç‡åç§°
      function getFrequencyName(frequency) {
        const names = {
          'daily': 'æ¯æ—¥æ¨è',
          'weekly': 'æ¯å‘¨æ¨è',
          'monthly': 'æ¯æœˆæ¨è',
          'never': 'ä¸æ¨è'
        };
        return names[frequency] || frequency;
      }

      // æ˜¾ç¤ºæ¨èå†…å®¹
      function displayRecommendations(tab = 'browsing') {
        const content = document.getElementById('recommendationContent');
        const recommendations = recommendationDatabase[tab] || [];
        const count = parseInt(document.getElementById('countSelect').value);
        const categoryFilter = document.getElementById('categoryFilter').value;

        // è¿‡æ»¤æ¨è
        let filteredRecommendations = recommendations;
        if (categoryFilter) {
          filteredRecommendations = recommendations.filter(book => book.category === categoryFilter);
        }

        // é™åˆ¶æ•°é‡
        filteredRecommendations = filteredRecommendations.slice(0, count);

        if (filteredRecommendations.length === 0) {
          content.innerHTML = `
            <div class="empty-recommendations">
              <i class="mdi mdi-lightbulb-outline"></i>
              <h5>æš‚æ— æ¨è</h5>
              <p>å½“å‰æ¡ä»¶ä¸‹æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ¨èå›¾ä¹¦ï¼Œè¯·å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶ã€‚</p>
              <button class="btn btn-primary" onclick="refreshRecommendations()">åˆ·æ–°æ¨è</button>
            </div>
          `;
          return;
        }

        const tabInfo = getTabInfo(tab);
        const recommendationsHTML = `
          <div class="tab-pane active">
            <div class="recommendation-header">
              <h5>${tabInfo.title}</h5>
              <p class="text-muted">${tabInfo.description}</p>
            </div>
            <div class="books-grid">
              ${filteredRecommendations.map(book => `
                <div class="book-card">
                  <div class="book-image">
                    <a href="book-detail.html?id=${book.id}">
                      <img src="${book.cover}" alt="${book.title}" class="book-cover">
                      ${book.isNew ? '<span class="new-badge">æ–°ä¹¦</span>' : ''}
                    </a>
                  </div>
                  <div class="book-info">
                    <h6 class="book-title">
                      <a href="book-detail.html?id=${book.id}">${book.title}</a>
                    </h6>
                    <p class="book-author">${book.author}</p>
                    <div class="book-price">
                      <span class="current-price">ï¿¥${book.price.toFixed(2)}</span>
                      ${book.originalPrice > book.price ?
                        `<span class="original-price">ï¿¥${book.originalPrice.toFixed(2)}</span>` : ''}
                    </div>
                    <div class="recommendation-reason">
                      <i class="mdi mdi-lightbulb"></i>
                      ${book.reason}
                    </div>
                    <div class="recommendation-score">
                      <span class="score-label">æ¨èåº¦:</span>
                      <div class="score-bar">
                        <div class="score-fill" style="width: ${book.score}%"></div>
                      </div>
                      <span class="score-value">${book.score}%</span>
                    </div>
                    <div class="book-actions">
                      <button class="btn btn-primary btn-sm" onclick="addToCart(${book.id})">
                        <i class="mdi mdi-cart-plus"></i>
                        åŠ å…¥è´­ç‰©è½¦
                      </button>
                      <button class="btn btn-outline-secondary btn-sm" onclick="addToWishlist(${book.id})">
                        <i class="mdi mdi-heart-outline"></i>
                      </button>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;

        content.innerHTML = recommendationsHTML;
      }

      // è·å–æ ‡ç­¾é¡µä¿¡æ¯
      function getTabInfo(tab) {
        const tabInfos = {
          'browsing': {
            title: 'åŸºäºæµè§ˆå†å²çš„æ¨è',
            description: 'æ ¹æ®æ‚¨æœ€è¿‘æµè§ˆçš„å›¾ä¹¦ï¼Œä¸ºæ‚¨æ¨èç›¸å…³çš„ä¼˜è´¨å›¾ä¹¦'
          },
          'purchase': {
            title: 'åŸºäºè´­ä¹°å†å²çš„æ¨è',
            description: 'æ ¹æ®æ‚¨çš„è´­ä¹°è®°å½•ï¼Œä¸ºæ‚¨æ¨èåŒç±»å‹çš„çƒ­é—¨å›¾ä¹¦'
          },
          'similar': {
            title: 'ç›¸ä¼¼ç”¨æˆ·æ¨è',
            description: 'ä¸æ‚¨å…´è¶£ç›¸ä¼¼çš„ç”¨æˆ·ä¹Ÿåœ¨é˜…è¯»è¿™äº›å›¾ä¹¦'
          },
          'popular': {
            title: 'çƒ­é—¨å›¾ä¹¦æ¨è',
            description: 'å½“å‰æœ€å—æ¬¢è¿çš„å›¾ä¹¦ï¼Œä¸å®¹é”™è¿‡çš„ç²¾å“'
          },
          'new': {
            title: 'æ–°ä¹¦æ¨è',
            description: 'æœ€æ–°ä¸Šæ¶çš„ä¼˜è´¨å›¾ä¹¦ï¼ŒæŠ¢å…ˆä½“éªŒ'
          }
        };
        return tabInfos[tab] || { title: 'æ¨èå›¾ä¹¦', description: 'ä¸ºæ‚¨ç²¾é€‰çš„ä¼˜è´¨å›¾ä¹¦' };
      }

      // åˆ‡æ¢æ ‡ç­¾é¡µ
      function switchTab(tab) {
        // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
        document.querySelectorAll('.nav-link').forEach(link => {
          link.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

        currentTab = tab;
        displayRecommendations(tab);
      }

      // æ›´æ–°æ¨è
      function updateRecommendations() {
        const algorithm = document.getElementById('algorithmSelect').value;
        switchTab(algorithm);
        showMessage('æ¨èå·²æ›´æ–°', 'success');
      }

      // åˆ·æ–°æ¨è
      function refreshRecommendations() {
        // æ¨¡æ‹Ÿåˆ·æ–°æ¨èç®—æ³•
        displayRecommendations(currentTab);
        showMessage('æ¨èå·²åˆ·æ–°', 'info');
      }

      // æ·»åŠ åˆ°è´­ç‰©è½¦
      function addToCart(bookId) {
        // æŸ¥æ‰¾å›¾ä¹¦ä¿¡æ¯
        let book = null;
        for (const category in recommendationDatabase) {
          book = recommendationDatabase[category].find(b => b.id === bookId);
          if (book) break;
        }

        if (book) {
          // è·å–ç°æœ‰è´­ç‰©è½¦
          let cart = JSON.parse(localStorage.getItem('cart') || '[]');

          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
          const existingIndex = cart.findIndex(item => item.id === bookId);
          if (existingIndex !== -1) {
            cart[existingIndex].quantity += 1;
          } else {
            cart.push({
              id: book.id,
              title: book.title,
              author: book.author,
              price: book.price,
              cover: book.cover,
              quantity: 1
            });
          }

          localStorage.setItem('cart', JSON.stringify(cart));
          updateCartCount();
          showMessage(`ã€Š${book.title}ã€‹å·²æ·»åŠ åˆ°è´­ç‰©è½¦`, 'success');
        }
      }

      // æ·»åŠ åˆ°æ”¶è—å¤¹
      function addToWishlist(bookId) {
        showMessage('æ”¶è—åŠŸèƒ½å¼€å‘ä¸­...', 'info');
      }

      // æ›´æ–°è´­ç‰©è½¦æ•°é‡æ˜¾ç¤º
      async function updateCartCount() {
        const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!authToken) {
          // æœªç™»å½•æ—¶æ˜¾ç¤º0
          const cartCount = document.getElementById('cartCount');
          if (cartCount) {
            cartCount.textContent = '0';
          }
          return;
        }

        try {
          const response = await fetch('http://1.94.203.175:5000/api/order/cart', {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });

          if (response.ok) {
            const result = await response.json();
            const cartCount = document.getElementById('cartCount');
            if (cartCount && result.data && result.data.items) {
              const totalItems = result.data.items.reduce((sum, item) => sum + item.quantity, 0);
              cartCount.textContent = totalItems;
              console.log('âœ… ä¸ºæ‚¨æ¨èé¡µé¢è´­ç‰©è½¦è®¡æ•°å·²æ›´æ–°:', totalItems);
            }
          } else {
            console.log('âš ï¸ è·å–è´­ç‰©è½¦æ•°æ®å¤±è´¥');
          }
        } catch (error) {
          console.error('âŒ æ›´æ–°è´­ç‰©è½¦è®¡æ•°å¤±è´¥:', error);
          // å‡ºé”™æ—¶ä¹Ÿæ˜¾ç¤º0
          const cartCount = document.getElementById('cartCount');
          if (cartCount) {
            cartCount.textContent = '0';
          }
        }
      }

      // æ˜¾ç¤ºæ¶ˆæ¯
      function showMessage(message, type = 'info') {
        const output = document.getElementById('form-output-global');
        const alertClass = type === 'success' ? 'alert-success' :
                          type === 'error' ? 'alert-danger' : 'alert-info';

        output.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        output.style.display = 'block';

        setTimeout(() => {
          output.style.display = 'none';
        }, 3000);
      }

      // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
      function checkUserStatus() {
        console.log('ğŸ” æ£€æŸ¥ç”¨æˆ·çŠ¶æ€ - æ¨èé¡µé¢');

        const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const userInfoStr = localStorage.getItem('userInfo');
        const username = localStorage.getItem('username');

        console.log('ç™»å½•æ•°æ®:', { authToken: !!authToken, isLoggedIn, userInfoStr: !!userInfoStr, username });

        const userMenu = document.getElementById('userMenu');
        const userDisplayName = document.getElementById('userDisplayName');
        const userDropdown = document.getElementById('userDropdown');

        if (!userMenu || !userDisplayName) {
          console.error('âŒ ç”¨æˆ·èœå•å…ƒç´ æœªæ‰¾åˆ°');
          return;
        }

        let userInfo = {};
        if (userInfoStr) {
          try {
            userInfo = JSON.parse(userInfoStr);
          } catch (error) {
            console.error('âŒ è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
          }
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆå¤šé‡æ£€æŸ¥ï¼‰
        const hasValidLogin = (
          (authToken && authToken !== 'null') &&
          (isLoggedIn === 'true') &&
          (userInfo.username || username)
        );

        console.log('ç™»å½•çŠ¶æ€åˆ¤æ–­:', hasValidLogin);

        if (hasValidLogin) {
          // ç”¨æˆ·å·²ç™»å½•
          const displayName = userInfo.username || username || 'ç”¨æˆ·';
          console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', displayName);

          userDisplayName.textContent = displayName;
          userMenu.href = '#';

          // ç»‘å®šä¸‹æ‹‰èœå•äº‹ä»¶
          userMenu.onclick = function(e) {
            e.preventDefault();
            toggleUserDropdown();
          };
        } else {
          // ç”¨æˆ·æœªç™»å½•
          console.log('âŒ ç”¨æˆ·æœªç™»å½•');
          userDisplayName.textContent = 'ç™»å½•';
          userMenu.href = 'login-page.html';
          userMenu.onclick = null;

          if (userDropdown) {
            userDropdown.style.display = 'none';
          }
        }
      }

      // åˆ‡æ¢ç”¨æˆ·ä¸‹æ‹‰èœå•
      function toggleUserDropdown() {
        const userDropdown = document.getElementById('userDropdown');
        if (userDropdown.style.display === 'none' || !userDropdown.style.display) {
          userDropdown.style.display = 'block';
        } else {
          userDropdown.style.display = 'none';
        }
      }

      // æ³¨é”€åŠŸèƒ½
      function logout() {
        if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
          localStorage.removeItem('userInfo');
          localStorage.removeItem('isLoggedIn');
          checkUserStatus();
          showMessage('å·²æˆåŠŸé€€å‡ºç™»å½•', 'info');
        }
      }

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.addEventListener('load', function() {
        checkUserStatus();
        updateCartCount();
        displayPreferenceSummary();
        displayRecommendations('browsing');

        // ç»‘å®šæ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
        document.querySelectorAll('.nav-link').forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const tab = this.getAttribute('data-tab');
            switchTab(tab);
          });
        });

        // ç»‘å®šè®¾ç½®å˜æ›´äº‹ä»¶
        document.getElementById('countSelect').addEventListener('change', function() {
          displayRecommendations(currentTab);
        });

        document.getElementById('categoryFilter').addEventListener('change', function() {
          displayRecommendations(currentTab);
        });

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', function(e) {
          const userDropdown = document.getElementById('userDropdown');
          const userMenu = document.getElementById('userMenu');

          if (!userMenu.contains(e.target) && !userDropdown.contains(e.target)) {
            userDropdown.style.display = 'none';
          }
        });
      });

      // å‘é€æ¨èé‚®ä»¶
      async function sendRecommendationEmail() {
        try {
          // è·å–ç”¨æˆ·ä¿¡æ¯
          const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
          const userEmail = userInfo.email || localStorage.getItem('userEmail');
          const username = userInfo.username || localStorage.getItem('username') || 'å°Šæ•¬çš„ç”¨æˆ·';

          if (!userEmail) {
            showMessage('è¯·å…ˆç™»å½•å¹¶è®¾ç½®é‚®ç®±åœ°å€', 'error');
            return;
          }

          // è·å–å½“å‰æ¨èçš„å›¾ä¹¦
          const currentRecommendations = getCurrentRecommendations();

          // å‘é€é‚®ä»¶
          const response = await fetch(`${EMAIL_API_BASE}/send`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email: userEmail,
              email_type: 'recommendation',
              username: username,
              user_id: userInfo.id,
              recommendation_data: {
                recommendations: currentRecommendations,
                recommendation_type: currentTab,
                username: username
              }
            })
          });

          const result = await response.json();

          if (response.ok) {
            showMessage('ğŸ“§ æ¨èé‚®ä»¶å‘é€æˆåŠŸï¼è¯·æŸ¥æ”¶é‚®ç®±', 'success');
          } else {
            throw new Error(result.error || 'é‚®ä»¶å‘é€å¤±è´¥');
          }

        } catch (error) {
          console.error('âŒ å‘é€æ¨èé‚®ä»¶æ—¶å‡ºé”™:', error);
          showMessage(`å‘é€æ¨èé‚®ä»¶å¤±è´¥: ${error.message}`, 'error');
        }
      }

      // è·å–å½“å‰æ¨èçš„å›¾ä¹¦
      function getCurrentRecommendations() {
        const count = parseInt(document.getElementById('countSelect').value);
        const category = document.getElementById('categoryFilter').value;

        let books = recommendationDatabase[currentTab] || [];

        // åº”ç”¨åˆ†ç±»ç­›é€‰
        if (category !== 'all') {
          books = books.filter(book => book.category === category);
        }

        // é™åˆ¶æ•°é‡
        return books.slice(0, count).map(book => ({
          title: book.title,
          author: book.author,
          price: book.price,
          reason: book.reason,
          score: book.score
        }));
      }

      // æ˜¾ç¤ºæ¶ˆæ¯
      function showMessage(message, type = 'info') {
        const output = document.getElementById('form-output-global');
        const alertClass = type === 'success' ? 'alert-success' :
                          type === 'error' ? 'alert-danger' : 'alert-info';

        output.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        output.style.display = 'block';

        setTimeout(() => {
          output.style.display = 'none';
        }, 3000);
      }

      // å»¶è¿Ÿæ›´æ–°è´­ç‰©è½¦è®¡æ•°
      setTimeout(updateCartCount, 2000);
      setTimeout(updateCartCount, 5000);
    </script>

    <!-- Recommendations Styles -->
    <style>
      .card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
      }

      .card-header {
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 20px;
      }

      .card-header h4, .card-header h5 {
        margin: 0;
        color: #333;
      }

      .card-body {
        padding: 20px;
      }

      .preference-summary {
        margin: 0;
      }

      .preference-item {
        margin-bottom: 20px;
      }

      .preference-item h6 {
        margin-bottom: 10px;
        color: #495057;
        font-weight: 600;
      }

      .preference-item p {
        margin: 5px 0;
        color: #666;
        font-size: 14px;
      }

      .category-tags, .browsing-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .category-tag, .browsing-tag {
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
      }

      .category-tag {
        background: #e3f2fd;
        color: #1976d2;
      }

      .browsing-tag {
        background: #f3e5f5;
        color: #7b1fa2;
      }

      .recommendation-tabs {
        margin-bottom: 30px;
      }

      .nav-tabs {
        border-bottom: 2px solid #dee2e6;
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .nav-item {
        margin-bottom: -2px;
      }

      .nav-link {
        display: block;
        padding: 12px 20px;
        color: #666;
        text-decoration: none;
        border: 2px solid transparent;
        border-bottom: none;
        border-radius: 8px 8px 0 0;
        transition: all 0.3s;
        background: #f8f9fa;
        margin-right: 5px;
      }

      .nav-link:hover {
        color: #007bff;
        background: #e9ecef;
        text-decoration: none;
      }

      .nav-link.active {
        color: #007bff;
        background: white;
        border-color: #dee2e6;
        border-bottom-color: white;
        font-weight: 600;
      }

      .tab-content {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0 8px 8px 8px;
        padding: 30px;
      }

      .recommendation-header {
        margin-bottom: 30px;
        text-align: center;
      }

      .recommendation-header h5 {
        margin-bottom: 10px;
        color: #333;
      }

      .books-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
      }

      .book-card {
        border: 1px solid #eee;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s;
        background: white;
      }

      .book-card:hover {
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        transform: translateY(-2px);
      }

      .book-image {
        position: relative;
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
      }

      .book-cover {
        width: 120px;
        height: 160px;
        object-fit: cover;
        border-radius: 4px;
      }

      .new-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ff4757;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
      }

      .book-info {
        padding: 15px;
      }

      .book-title {
        margin: 0 0 8px 0;
        font-size: 16px;
      }

      .book-title a {
        color: #333;
        text-decoration: none;
        font-weight: 600;
        line-height: 1.3;
      }

      .book-title a:hover {
        color: #007bff;
        text-decoration: none;
      }

      .book-author {
        margin: 0 0 10px 0;
        color: #666;
        font-size: 14px;
      }

      .book-price {
        margin-bottom: 12px;
      }

      .current-price {
        color: #e74c3c;
        font-weight: 600;
        font-size: 16px;
      }

      .original-price {
        color: #999;
        text-decoration: line-through;
        font-size: 14px;
        margin-left: 8px;
      }

      .recommendation-reason {
        background: #fff3cd;
        color: #856404;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        margin-bottom: 12px;
        border-left: 3px solid #ffc107;
      }

      .recommendation-reason i {
        color: #ffc107;
        margin-right: 5px;
      }

      .recommendation-score {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 15px;
        font-size: 12px;
      }

      .score-label {
        color: #666;
        font-weight: 500;
      }

      .score-bar {
        flex: 1;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
      }

      .score-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s;
      }

      .score-value {
        color: #28a745;
        font-weight: 600;
      }

      .book-actions {
        display: flex;
        gap: 8px;
      }

      .btn {
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: all 0.3s;
        font-weight: 500;
      }

      .btn-primary {
        background: #007bff;
        color: white;
        flex: 1;
      }

      .btn-primary:hover {
        background: #0056b3;
        text-decoration: none;
        color: white;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #545b62;
        text-decoration: none;
        color: white;
      }

      .btn-outline-secondary {
        background: transparent;
        color: #6c757d;
        border: 1px solid #6c757d;
        padding: 7px 11px;
      }

      .btn-outline-secondary:hover {
        background: #6c757d;
        color: white;
        text-decoration: none;
      }

      .btn-outline-primary {
        background: transparent;
        color: #007bff;
        border: 1px solid #007bff;
      }

      .btn-outline-primary:hover {
        background: #007bff;
        color: white;
        text-decoration: none;
      }

      .btn-sm {
        padding: 6px 10px;
        font-size: 12px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #495057;
        font-weight: 500;
        font-size: 14px;
      }

      .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
      }

      .empty-recommendations {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-recommendations i {
        font-size: 48px;
        color: #ccc;
        margin-bottom: 20px;
      }

      .empty-recommendations h5 {
        margin-bottom: 10px;
        color: #333;
      }

      .empty-recommendations p {
        margin-bottom: 20px;
      }

      .text-center {
        text-align: center;
      }

      .text-muted {
        color: #6c757d;
      }

      .mt-3 {
        margin-top: 1rem;
      }

      .mt-4 {
        margin-top: 1.5rem;
      }

      .mb-4 {
        margin-bottom: 1.5rem;
      }

      .button-group {
        display: flex;
        gap: 25px;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 15px;
      }

      .button-group .btn {
        flex: 0 0 auto;
        min-width: 130px;
        margin: 0;
      }

      .row {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -15px;
      }

      .col-md-4 {
        flex: 0 0 33.333333%;
        max-width: 33.333333%;
        padding: 0 15px;
      }

      /* User dropdown styles */
      .rd-navbar-user {
        position: relative;
      }

      .user-icon {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #333;
        text-decoration: none;
        padding: 8px 12px;
        border-radius: 4px;
        transition: background 0.3s;
      }

      .user-icon:hover {
        background: #f8f9fa;
        text-decoration: none;
        color: #333;
      }

      .user-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        min-width: 150px;
        z-index: 1000;
      }

      .user-dropdown a {
        display: block;
        padding: 10px 15px;
        color: #333;
        text-decoration: none;
        border-bottom: 1px solid #eee;
        transition: background 0.3s;
      }

      .user-dropdown a:last-child {
        border-bottom: none;
      }

      .user-dropdown a:hover {
        background: #f8f9fa;
        text-decoration: none;
      }

      /* Shopping cart styles */
      .rd-navbar-cart {
        margin-left: 15px;
      }

      .cart-icon {
        position: relative;
        color: #333;
        text-decoration: none;
        padding: 8px;
        border-radius: 4px;
        transition: background 0.3s;
      }

      .cart-icon:hover {
        background: #f8f9fa;
        text-decoration: none;
        color: #333;
      }

      .cart-count {
        position: absolute;
        top: 0;
        right: 0;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transform: translate(50%, -50%);
      }

      @media (max-width: 768px) {
        .col-md-4 {
          flex: 0 0 100%;
          max-width: 100%;
          margin-bottom: 20px;
        }

        .books-grid {
          grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
          gap: 20px;
        }

        .nav-tabs {
          flex-direction: column;
        }

        .nav-item {
          margin-bottom: 5px;
        }

        .nav-link {
          margin-right: 0;
          border-radius: 4px;
        }

        .tab-content {
          border-radius: 8px;
          padding: 20px;
        }

        .book-actions {
          flex-direction: column;
        }

        .category-tags, .browsing-tags {
          justify-content: center;
        }
      }
    </style>
