<!DOCTYPE html>
<html class="wide wow-animation" lang="zh-CN">
  <head>
    <!-- 网站标题-->
    <title>忘记密码 - 华轩书店</title>
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <!-- 样式表-->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:700%7CLato:300,400,300italic,700">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fonts.css">
		<!--[if lt IE 10]>
    <div style="background: #212121; padding: 10px 0; box-shadow: 3px 3px 5px 0 rgba(0,0,0,.3); clear: both; text-align:center; position: relative; z-index:1;"><a href="http://windows.microsoft.com/en-US/internet-explorer/"><img src="images/ie8-panel/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="您正在使用过时的浏览器。为了获得更快更安全的浏览体验，请免费升级。"></a></div>
    <script src="js/html5shiv.min.js"></script>
		<![endif]-->
  </head>
  <body>
    <!-- Page preloader-->
    <div class="page-loader">
      <div class="page-loader-body">
        <div class="preloader-wrapper big active">
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"> </div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Page-->
    <div class="page">
      <!-- Page Header-->
      <header class="section page-header">
        <!-- RD Navbar-->
        <div class="rd-navbar-wrap rd-navbar-centered">
          <nav class="rd-navbar novi-background" data-layout="rd-navbar-fixed" data-sm-layout="rd-navbar-fixed" data-md-layout="rd-navbar-fixed" data-md-device-layout="rd-navbar-fixed" data-lg-layout="rd-navbar-fullwidth" data-lg-device-layout="rd-navbar-fixed" data-xl-layout="rd-navbar-static" data-xl-device-layout="rd-navbar-static" data-md-stick-up-offset="1px" data-lg-stick-up-offset="1px" data-stick-up="true" data-sm-stick-up="true" data-md-stick-up="true" data-lg-stick-up="true" data-xl-stick-up="true">
            <div class="rd-navbar-inner">
              <div class="rd-navbar-aside-left">
                <div class="rd-navbar-nav-wrap">
                  <!-- RD Navbar Nav-->
                  <ul class="rd-navbar-nav">
                    <li><a href="index.html">首页</a></li>
                    <li><a href="#">图书分类</a>
                      <!-- RD Navbar Dropdown-->
                      <ul class="rd-navbar-dropdown">
                        <li><a href="category.html?type=business">商业管理</a></li>
                        <li><a href="category.html?type=technology">科技计算机</a></li>
                        <li><a href="category.html?type=literature">文学艺术</a></li>
                        <li><a href="category.html?type=education">教育考试</a></li>
                        <li><a href="category.html?type=children">少儿读物</a></li>
                        <li><a href="category.html?type=life">生活休闲</a></li>
                        <li><a href="category.html?type=social">社会科学</a></li>
                      </ul>
                    </li>
                    <li><a href="category.html">全部图书</a></li>
                  </ul>
                </div>
              </div>
              <!-- RD Navbar Panel-->
              <div class="rd-navbar-panel">
                <button class="rd-navbar-toggle" data-rd-navbar-toggle=".rd-navbar-nav-wrap"><span></span></button>
                <!-- RD Navbar Brand-->
                <div class="rd-navbar-brand">
                  <a class="brand-name" href="index.html">
                    <img class="logo-default" src="images/logo-default-161x57.png" alt="华轩书店" width="161" height="57"/>
                    <img class="logo-inverse" src="images/logo-inverse-161x57.png" alt="华轩书店" width="161" height="57"/>
                  </a>
                </div>
              </div>
              <div class="rd-navbar-collapse-toggle" data-rd-navbar-toggle=".rd-navbar-collapse"><span></span></div>
              <div class="rd-navbar-aside-right rd-navbar-collapse">
                <!-- RD Navbar Search-->
                <div class="rd-navbar-search">
                  <a class="rd-navbar-search-toggle" data-rd-navbar-toggle=".rd-navbar-search" href="#"><span></span></a>
                  <form class="rd-search" action="search.html" data-search-live="rd-search-results-live" method="GET">
                    <div class="form-wrap">
                      <label class="form-label form-label" for="rd-navbar-search-form-input">搜索图书...</label>
                      <input class="rd-navbar-search-form-input form-input" id="rd-navbar-search-form-input" type="text" name="keyword" autocomplete="off">
                      <div class="rd-search-results-live"></div>
                    </div>
                    <button class="rd-search-form-submit mdi mdi-magnify"></button>
                  </form>
                </div>
                <!-- User Menu -->
                <div class="rd-navbar-user">
                  <a href="login-page.html" class="user-icon">
                    <i class="mdi mdi-account"></i>
                    <span>登录</span>
                  </a>
                </div>
                <!-- Shopping Cart -->
                <div class="rd-navbar-cart">
                  <a href="shopping-cart.html" class="cart-icon">
                    <i class="mdi mdi-cart"></i>
                    <span class="cart-count">0</span>
                  </a>
                </div>
              </div>
            </div>
          </nav>
        </div>
      </header>
      <section class="single-screen section fullwidth-page">
        <div class="fullwidth-page-inner" style="display: flex; align-items: flex-start; justify-content: center; min-height: 100vh; padding-top: 90px;">
          <div class="section-md" style="width: 100%;">
            <div class="container">
              <div class="row">
                <div class="col-md-10 col-lg-8 col-xl-6" style="margin-left: 35%;">
                  <div class="card" style="padding: 60px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
                    <h3 class="text-primary mb-4" style="margin-bottom: 40px; font-size: 28px;">找回密码</h3>
                    <p class="text-muted mb-4" style="margin-bottom: 30px; font-size: 16px;">请输入您的注册邮箱，我们将发送重置密码的链接到您的邮箱。</p>
                    <!-- Reset Password Form-->
                    <form class="rd-mailform form-fix" id="forgotPasswordForm" method="POST" action="/api/forgot-password" style="margin-top: 30px;">
                      <div class="form-wrap form-wrap-validation">
                        <input class="form-input" id="forms-reset-email" type="email" name="email" data-constraints="@Required @Email" style="background: #f8f9fa; font-size: 16px; padding: 15px;">
                        <label class="form-label" for="forms-reset-email">电子邮箱</label>
                      </div>
                      <div class="form-wrap">
                        <button class="button button-block button-primary" type="submit" style="font-size: 18px; padding: 15px;">发送重置链接</button>
                      </div>
                      <div class="form-wrap text-center" style="margin-top: 25px;">
                        <p style="font-size: 16px;"><a href="login-page.html">返回登录</a></p>
                        <p style="font-size: 16px;">还没有账号？ <a href="registration-page.html">立即注册</a></p>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="fullwidth-page-footer text-center">
          <p class="rights"><span>&copy;&nbsp;</span><span class="copyright-year"></span><span>&nbsp;</span><span>华轩书店</span><span>. 保留所有权利.</span></p>
        </div>
      </section>
    </div>
    <!-- Global Mailform Output-->
    <div class="snackbars" id="form-output-global"></div>
    <!-- Javascript-->
    <script src="js/core.min.js"></script>
    <script src="js/script.js"></script>
    <!-- Forgot Password specific scripts -->
    <script>
      let currentStep = 1; // 1: 输入邮箱, 2: 输入验证码, 3: 重置密码
      let verificationCode = '';
      let userEmail = '';

      // 邮件服务API配置
      const EMAIL_API_BASE = 'http://127.0.0.1:5000/api/email';

      // 生成6位随机验证码
      function generateVerificationCode() {
        return Math.floor(100000 + Math.random() * 900000).toString();
      }

      // 显示消息
      function showMessage(message, type = 'info') {
        const output = document.getElementById('form-output-global');
        const alertClass = type === 'success' ? 'alert-success' :
                          type === 'error' ? 'alert-danger' : 'alert-info';

        output.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        output.style.display = 'block';

        setTimeout(() => {
          output.style.display = 'none';
        }, 5000);
      }

      // 步骤1：发送验证码
      async function sendVerificationCode(email) {
        try {
          // 显示发送中状态
          showMessage('正在发送验证码，请稍候...', 'info');

          // 生成验证码
          verificationCode = generateVerificationCode();
          userEmail = email;

          // 发送邮件
          const response = await fetch(`${EMAIL_API_BASE}/send`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email: email,
              email_type: 'password_reset',
              user_id: null,
              verification_code: verificationCode
            })
          });

          const data = await response.json();

          if (response.ok) {
            showMessage(`验证码已发送到 ${email}，请查收邮件。`, 'success');
            console.log('验证码（开发调试）：', verificationCode); // 开发时显示，生产环境应删除

            // 切换到验证码输入界面
            showVerificationStep();
            return true;
          } else {
            showMessage(`发送失败：${data.error}`, 'error');
            return false;
          }
        } catch (error) {
          console.error('发送验证码时出错:', error);
          showMessage('网络错误，请检查邮件服务是否正常运行', 'error');
          return false;
        }
      }

      // 显示验证码输入界面
      function showVerificationStep() {
        const formContainer = document.querySelector('.card');
        formContainer.innerHTML = `
          <h3 class="text-primary mb-4" style="margin-bottom: 40px; font-size: 28px;">输入验证码</h3>
          <p class="text-muted mb-4" style="margin-bottom: 30px; font-size: 16px;">
            我们已向 <strong>${userEmail}</strong> 发送了6位验证码，请查收邮件并输入验证码。
          </p>
          <form id="verificationForm" style="margin-top: 30px;">
            <div class="form-wrap form-wrap-validation">
              <input class="form-input" id="verification-code" type="text" name="code" maxlength="6"
                     style="background: #f8f9fa; font-size: 20px; padding: 15px; text-align: center; letter-spacing: 5px;"
                     placeholder="请输入6位验证码">
              <label class="form-label" for="verification-code">验证码</label>
            </div>
            <div class="form-wrap">
              <button class="button button-block button-primary" type="submit"
                      style="font-size: 18px; padding: 15px;">验证并继续</button>
            </div>
            <div class="form-wrap text-center" style="margin-top: 25px;">
              <p style="font-size: 16px;">
                <a href="#" onclick="resendCode()" style="color: #007bff;">重新发送验证码</a>
              </p>
              <p style="font-size: 16px;">
                <a href="#" onclick="backToEmailStep()">返回上一步</a>
              </p>
            </div>
          </form>
        `;

        // 绑定验证码表单提交事件
        document.getElementById('verificationForm').addEventListener('submit', function(e) {
          e.preventDefault();
          const inputCode = document.getElementById('verification-code').value;

          if (inputCode === verificationCode) {
            showMessage('验证码正确！', 'success');
            setTimeout(() => {
              showPasswordResetStep();
            }, 1000);
          } else {
            showMessage('验证码错误，请重新输入', 'error');
          }
        });
      }

      // 显示密码重置界面
      function showPasswordResetStep() {
        const formContainer = document.querySelector('.card');
        formContainer.innerHTML = `
          <h3 class="text-primary mb-4" style="margin-bottom: 40px; font-size: 28px;">重置密码</h3>
          <p class="text-muted mb-4" style="margin-bottom: 30px; font-size: 16px;">
            请为您的账号设置新密码。
          </p>
          <form id="resetPasswordForm" style="margin-top: 30px;">
            <div class="form-wrap form-wrap-validation">
              <input class="form-input" id="new-password" type="password" name="password"
                     style="background: #f8f9fa; font-size: 16px; padding: 15px;"
                     placeholder="请输入新密码">
              <label class="form-label" for="new-password">新密码</label>
            </div>
            <div class="form-wrap form-wrap-validation">
              <input class="form-input" id="confirm-password" type="password" name="confirmPassword"
                     style="background: #f8f9fa; font-size: 16px; padding: 15px;"
                     placeholder="请再次输入新密码">
              <label class="form-label" for="confirm-password">确认密码</label>
            </div>
            <div class="password-requirements" style="margin: 15px 0; font-size: 14px; color: #666;">
              <p>密码要求：</p>
              <ul style="margin-left: 20px;">
                <li>至少8个字符</li>
                <li>包含大小写字母</li>
                <li>包含数字</li>
                <li>包含特殊字符</li>
              </ul>
            </div>
            <div class="form-wrap">
              <button class="button button-block button-primary" type="submit"
                      style="font-size: 18px; padding: 15px;">重置密码</button>
            </div>
          </form>
        `;

        // 绑定密码重置表单提交事件
        document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
          e.preventDefault();

          const newPassword = document.getElementById('new-password').value;
          const confirmPassword = document.getElementById('confirm-password').value;

          // 验证密码
          if (newPassword.length < 8) {
            showMessage('密码长度至少为8个字符', 'error');
            return;
          }

          if (newPassword !== confirmPassword) {
            showMessage('两次输入的密码不一致', 'error');
            return;
          }

          // 模拟密码重置成功
          showMessage('密码重置成功！正在跳转到登录页面...', 'success');

          // 保存新密码到localStorage（实际应用中应该发送到后端）
          const users = JSON.parse(localStorage.getItem('users') || '[]');
          const userIndex = users.findIndex(user => user.email === userEmail);
          if (userIndex !== -1) {
            users[userIndex].password = newPassword;
            localStorage.setItem('users', JSON.stringify(users));
          }

          setTimeout(() => {
            window.location.href = 'login-page.html';
          }, 2000);
        });
      }

      // 重新发送验证码
      async function resendCode() {
        try {
          showMessage('正在重新发送验证码...', 'info');

          verificationCode = generateVerificationCode();

          const response = await fetch(`${EMAIL_API_BASE}/send`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email: userEmail,
              email_type: 'password_reset',
              user_id: null,
              verification_code: verificationCode
            })
          });

          const data = await response.json();

          if (response.ok) {
            showMessage(`新的验证码已发送到 ${userEmail}`, 'success');
            console.log('新验证码（开发调试）：', verificationCode);
          } else {
            showMessage(`重新发送失败：${data.error}`, 'error');
          }
        } catch (error) {
          console.error('重新发送验证码时出错:', error);
          showMessage('网络错误，请稍后重试', 'error');
        }
      }

      // 返回邮箱输入步骤
      function backToEmailStep() {
        location.reload();
      }

      // 初始表单提交处理
      document.getElementById('forgotPasswordForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const email = document.getElementById('forms-reset-email').value;

        if (!email) {
          showMessage('请输入邮箱地址', 'error');
          return;
        }

        // 验证邮箱格式
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showMessage('请输入有效的邮箱地址', 'error');
          return;
        }

        sendVerificationCode(email);
      });
    </script>
  </body>
</html>
