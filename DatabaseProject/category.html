<!DOCTYPE html>
<html class="wide wow-animation" lang="zh-CN">
  <head>
    <!-- Site Title-->
    <title>图书分类 - 华轩书店</title>
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <!-- Stylesheets-->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:700%7CLato:300,400,300italic,700">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fonts.css">
		<!--[if lt IE 10]>
    <div style="background: #212121; padding: 10px 0; box-shadow: 3px 3px 5px 0 rgba(0,0,0,.3); clear: both; text-align:center; position: relative; z-index:1;"><a href="http://windows.microsoft.com/en-US/internet-explorer/"><img src="images/ie8-panel/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="您正在使用过时的浏览器。为了获得更快更安全的浏览体验，请免费升级。"></a></div>
    <script src="js/html5shiv.min.js"></script>
		<![endif]-->
  </head>
  <body>
    <!-- Page-->
    <div class="page">
      <!-- Page Header-->
      <header class="section page-header">
        <!-- RD Navbar-->
        <div class="rd-navbar-wrap rd-navbar-centered">
          <nav class="rd-navbar novi-background" data-layout="rd-navbar-fixed" data-sm-layout="rd-navbar-fixed" data-md-layout="rd-navbar-fixed" data-md-device-layout="rd-navbar-fixed" data-lg-layout="rd-navbar-fullwidth" data-lg-device-layout="rd-navbar-fixed" data-xl-layout="rd-navbar-static" data-xl-device-layout="rd-navbar-static" data-md-stick-up-offset="1px" data-lg-stick-up-offset="1px" data-stick-up="true" data-sm-stick-up="true" data-md-stick-up="true" data-lg-stick-up="true" data-xl-stick-up="true">
            <div class="rd-navbar-inner">
              <div class="rd-navbar-aside-left">
                <div class="rd-navbar-nav-wrap">
                  <!-- RD Navbar Nav-->
                  <ul class="rd-navbar-nav">
                    <li><a href="index.html">首页</a></li>
                    <li class="active"><a href="#">图书分类</a>
                      <!-- RD Navbar Dropdown-->
                      <ul class="rd-navbar-dropdown">
                        <li><a href="category.html?type=business">商业管理</a></li>
                        <li><a href="category.html?type=technology">科技计算机</a></li>
                        <li><a href="category.html?type=literature">文学艺术</a></li>
                        <li><a href="category.html?type=education">教育考试</a></li>
                        <li><a href="category.html?type=children">少儿读物</a></li>
                        <li><a href="category.html?type=life">生活休闲</a></li>
                        <li><a href="category.html?type=social">社会科学</a></li>
                      </ul>
                    </li>
                    <li><a href="recommendations.html">为您推荐</a></li>
                    <li><a href="forum.html">读者论坛</a></li>
                  </ul>
                </div>
              </div>
              <!-- RD Navbar Panel-->
              <div class="rd-navbar-panel">
                <button class="rd-navbar-toggle" data-rd-navbar-toggle=".rd-navbar-nav-wrap"><span></span></button>
                <!-- RD Navbar Brand-->
                <div class="rd-navbar-brand"><a class="brand-name" href="index.html"><img class="logo-default" src="images/logo-default-161x57.png" alt="华轩书店" width="161" height="57"/><img class="logo-inverse" src="images/logo-inverse-161x57.png" alt="华轩书店" width="161" height="57"/></a></div>
              </div>
              <div class="rd-navbar-collapse-toggle" data-rd-navbar-toggle=".rd-navbar-collapse"><span></span></div>
              <div class="rd-navbar-aside-right rd-navbar-collapse">
                <!-- RD Navbar Search-->
                <div class="rd-navbar-search"><a class="rd-navbar-search-toggle" data-rd-navbar-toggle=".rd-navbar-search" href="#"><span></span></a>
                  <form class="rd-search" action="search-results.html" data-search-live="rd-search-results-live" method="GET">
                    <div class="form-wrap">
                      <label class="form-label form-label" for="rd-navbar-search-form-input">搜索图书...</label>
                      <input class="rd-navbar-search-form-input form-input" id="rd-navbar-search-form-input" type="text" name="keyword" autocomplete="off">
                      <div class="rd-search-results-live"></div>
                    </div>
                    <button class="rd-search-form-submit mdi mdi-magnify"></button>
                  </form>
                </div>
                <!-- User Menu -->
                <div class="rd-navbar-user">
                  <a href="login-page.html" class="user-icon" id="userMenu">
                    <i class="mdi mdi-account"></i>
                    <span id="userDisplayName">登录</span>
                  </a>
                  <div class="user-dropdown" id="userDropdown" style="display: none;">
                    <a href="user-profile.html">个人资料</a>
                    <a href="order-history.html">我的订单</a>
                    <a href="browsing-history.html">浏览历史</a>
                    <a href="user-preferences.html">偏好设置</a>
                    <a href="change-password.html">修改密码</a>
                    <a href="#" onclick="logout()">退出登录</a>
                  </div>
                </div>
                <!-- Shopping Cart -->
                <div class="rd-navbar-cart">
                  <a href="shopping-cart.html" class="cart-icon" id="cartIcon">
                    <i class="mdi mdi-cart"></i>
                    <span class="cart-count" id="cartCount">0</span>
                  </a>
                </div>
              </div>
            </div>
          </nav>
        </div>
      </header>
      <!-- Breadcrumbs-->
      <section class="breadcrumbs-custom" style="background-image: url(images/breadcrumbs-bg.jpg)">
        <div class="container">
          <p class="breadcrumbs-custom-subtitle">浏览全部图书</p>
          <p class="heading-1 breadcrumbs-custom-title">图书分类</p>
          <ul class="breadcrumbs-custom-path">
            <li><a href="index.html">首页</a></li>
            <li class="active">图书分类</li>
          </ul>
        </div>
      </section>

      <!-- Book Catalog-->
      <section class="section section-lg bg-default">
        <div class="container">
          <div class="row row-70">
            <div class="col-lg-3">
              <!-- Book Categories-->
              <div class="aside-item">
                <h6>图书分类</h6>
                <ul class="list-marked list-categories">
                  <li><a href="category.html?type=business">商业管理</a></li>
                  <li><a href="category.html?type=technology">科技计算机</a></li>
                  <li><a href="category.html?type=literature" class="active">文学艺术</a></li>
                  <li><a href="category.html?type=education">教育考试</a></li>
                  <li><a href="category.html?type=children">少儿读物</a></li>
                  <li><a href="category.html?type=life">生活休闲</a></li>
                  <li><a href="category.html?type=social">社会科学</a></li>
                </ul>
              </div>

              <!-- Filter by Publisher-->
              <div class="aside-item">
                <h6>出版社</h6>
                <div class="group-xs group-middle">
                  <div class="checkbox-inline">
                    <label>
                      <input type="checkbox" name="publisher" value="人民文学出版社">人民文学出版社
                    </label>
                  </div>
                  <div class="checkbox-inline">
                    <label>
                      <input type="checkbox" name="publisher" value="机械工业出版社">机械工业出版社
                    </label>
                  </div>
                  <div class="checkbox-inline">
                    <label>
                      <input type="checkbox" name="publisher" value="电子工业出版社">电子工业出版社
                    </label>
                  </div>
                  <div class="checkbox-inline">
                    <label>
                      <input type="checkbox" name="publisher" value="人民教育出版社">人民教育出版社
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-9">
              <div class="row row-30" id="booksContainer">
                <!-- 图书将通过JavaScript动态加载 -->
              </div>
              <!-- 图书总数显示 -->
              <div class="text-center mt-4">
                <p class="text-muted" id="bookCount">正在加载图书...</p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <!-- Global Mailform Output-->
    <div class="snackbars" id="form-output-global"></div>
    <!-- Javascript-->
    <script src="js/core.min.js"></script>
    <script src="js/script.js"></script>

    <!-- Category Page Styles -->
    <style>
      /* 用户下拉菜单样式 */
      .rd-navbar-user {
        position: relative;
      }

      .user-icon {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 4px;
        color: #333;
        text-decoration: none;
        transition: background-color 0.3s ease;
        cursor: pointer;
      }

      .user-icon:hover {
        background-color: #f5f5f5;
        text-decoration: none;
        color: #333;
      }

      .user-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        min-width: 150px;
        z-index: 1000;
      }

      .user-dropdown a {
        display: block;
        padding: 10px 15px;
        color: #333;
        text-decoration: none;
        border-bottom: 1px solid #eee;
        transition: background-color 0.3s ease;
      }

      .user-dropdown a:hover {
        background-color: #f5f5f5;
        color: #007bff;
      }

      .user-dropdown a:last-child {
        border-bottom: none;
      }

      /* 购物车和用户图标对齐调整 */
      .rd-navbar-user,
      .rd-navbar-cart {
        display: flex;
        align-items: center;
      }

      .rd-navbar-cart .cart-icon {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 4px;
        color: #333;
        text-decoration: none;
        transition: background-color 0.3s ease;
        position: relative;
      }

      .rd-navbar-cart .cart-icon:hover {
        background-color: #f5f5f5;
        text-decoration: none;
        color: #333;
      }

      .cart-count {
        background: #dc3545;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
        min-width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        line-height: 1.2;
      }

      /* 图标大小调整 */
      .rd-navbar-user .mdi,
      .rd-navbar-cart .mdi {
        font-size: 20px;
        line-height: 1;
      }

      /* 产品卡片样式 */
      .product {
        border: 1px solid #eee;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .product:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transform: translateY(-2px);
      }

      .product-image {
        position: relative;
        overflow: hidden;
      }

      .product-image img {
        width: 100%;
        height: 280px;
        object-fit: cover;
        transition: transform 0.3s ease;
      }

      .product:hover .product-image img {
        transform: scale(1.05);
      }

      .product-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .product:hover .product-overlay {
        opacity: 1;
      }

      .product-actions {
        display: flex;
        gap: 15px;
      }

      .product-btn {
        width: 40px;
        height: 40px;
        background: white;
        color: #333;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        font-size: 18px;
        transition: all 0.3s ease;
        line-height: 1;
        vertical-align: middle;
      }

      .product-btn::before {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
      }

      .product-btn:hover {
        background: #007bff;
        color: white;
        transform: scale(1.1);
      }

      .product-title {
        padding: 20px;
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .product-title h5 {
        margin-bottom: 8px;
        font-size: 16px;
        line-height: 1.4;
      }

      .product-title h5 a {
        color: #333;
        text-decoration: none;
      }

      .product-title h5 a:hover {
        color: #007bff;
      }

      .product-author {
        font-size: 13px;
        color: #666;
        margin-bottom: 4px;
      }

      .product-price {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
        padding: 0 20px 20px 20px;
      }

      .product-price-old {
        font-size: 14px;
        color: #999;
        text-decoration: line-through;
      }

      .product-price-new {
        font-size: 18px;
        color: #e74c3c;
        font-weight: 600;
      }

      .product-stock {
        padding: 8px 20px;
        text-align: center;
        font-size: 13px;
        font-weight: 500;
      }

      .product-stock.in-stock {
        color: #28a745;
        background: rgba(40, 167, 69, 0.1);
        border-top: 1px solid rgba(40, 167, 69, 0.2);
      }

      .product-stock.out-of-stock {
        color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
        border-top: 1px solid rgba(220, 53, 69, 0.2);
      }

      @media (max-width: 768px) {
        .product-actions {
          gap: 10px;
        }

        .product-btn {
          width: 35px;
          height: 35px;
          font-size: 16px;
        }
      }
    </style>

    <!-- Category specific scripts -->
    <script>
      // 图书数据库（与book-detail.html保持一致）
      const booksDatabase = {
        1: {
          id: 1,
          title: '领导力的艺术',
          author: '约翰·麦克斯韦尔',
          publisher: '中信出版社',
          originalPrice: 45.00,
          price: 35.00,
          stock: 120,
          cover: 'images/book-02-188x246.jpg',
          category: 'business'
        },
        2: {
          id: 2,
          title: '创新思维与商业模式',
          author: '克莱顿·克里斯坦森',
          publisher: '机械工业出版社',
          originalPrice: 52.00,
          price: 39.00,
          stock: 85,
          cover: 'images/book-03-188x246.jpg',
          category: 'business'
        },
        3: {
          id: 3,
          title: '数字化转型战略',
          author: '迈克尔·韦德',
          publisher: '清华大学出版社',
          originalPrice: 48.00,
          price: 36.00,
          stock: 95,
          cover: 'images/book-04-188x246.jpg',
          category: 'business'
        },
        4: {
          id: 4,
          title: 'Python编程从入门到实践',
          author: '埃里克·马瑟斯',
          publisher: '人民邮电出版社',
          originalPrice: 89.00,
          price: 69.00,
          stock: 150,
          cover: 'images/book-05-188x246.jpg',
          category: 'technology'
        },
        5: {
          id: 5,
          title: '深度学习',
          author: '伊恩·古德费洛',
          publisher: '人民邮电出版社',
          originalPrice: 168.00,
          price: 128.00,
          stock: 75,
          cover: 'images/book-06-188x246.jpg',
          category: 'technology'
        },
        6: {
          id: 6,
          title: '算法导论',
          author: '托马斯·科尔曼',
          publisher: '机械工业出版社',
          originalPrice: 128.00,
          price: 98.00,
          stock: 60,
          cover: 'images/book-07-188x246.jpg',
          category: 'technology'
        },
        7: {
          id: 7,
          title: '网页设计与前端开发',
          author: '张三',
          publisher: '电子工业出版社',
          originalPrice: 78.00,
          price: 58.00,
          stock: 110,
          cover: 'images/book-08-188x246.jpg',
          category: 'technology'
        },
        8: {
          id: 8,
          title: '百年孤独',
          author: '加西亚·马尔克斯',
          publisher: '南海出版公司',
          originalPrice: 39.50,
          price: 29.00,
          stock: 88,
          cover: 'images/book-02-188x246.jpg',
          category: 'literature'
        },
        // 文学艺术类
        9: {
          id: 9,
          title: '百年孤独',
          author: '加西亚·马尔克斯',
          publisher: '南海出版公司',
          originalPrice: 45.00,
          price: 32.00,
          cover: 'images/book-02-188x246.jpg',
          category: 'literature'
        },
        10: {
          id: 10,
          title: '活着',
          author: '余华',
          publisher: '作家出版社',
          originalPrice: 28.00,
          price: 22.00,
          cover: 'images/book-03-188x246.jpg',
          category: 'literature'
        },
        11: {
          id: 11,
          title: '诗经选读',
          author: '孔子编',
          publisher: '中华书局',
          originalPrice: 32.00,
          price: 25.00,
          cover: 'images/book-04-188x246.jpg',
          category: 'literature'
        },
        // 教育考试类
        12: {
          id: 12,
          title: '高等数学',
          author: '同济大学数学系',
          publisher: '高等教育出版社',
          originalPrice: 58.00,
          price: 45.00,
          cover: 'images/book-05-188x246.jpg',
          category: 'education'
        },
        13: {
          id: 13,
          title: '英语四级真题详解',
          author: '王长喜',
          publisher: '外语教学与研究出版社',
          originalPrice: 42.00,
          price: 33.00,
          cover: 'images/book-06-188x246.jpg',
          category: 'education'
        },
        14: {
          id: 14,
          title: '考研政治核心考点',
          author: '肖秀荣',
          publisher: '国家行政学院出版社',
          originalPrice: 48.00,
          price: 38.00,
          cover: 'images/book-07-188x246.jpg',
          category: 'education'
        },
        // 少儿读物类
        15: {
          id: 15,
          title: '小王子',
          author: '安托万·德·圣埃克苏佩里',
          publisher: '人民文学出版社',
          originalPrice: 25.00,
          price: 18.00,
          cover: 'images/book-08-188x246.jpg',
          category: 'children'
        },
        16: {
          id: 16,
          title: '安徒生童话选集',
          author: '汉斯·克里斯蒂安·安徒生',
          publisher: '译林出版社',
          originalPrice: 32.00,
          price: 24.00,
          cover: 'images/books/book-1.jpg',
          category: 'children'
        },
        17: {
          id: 17,
          title: '十万个为什么（少儿版）',
          author: '叶永烈',
          publisher: '少年儿童出版社',
          originalPrice: 38.00,
          price: 28.00,
          cover: 'images/book-02-188x246.jpg',
          category: 'children'
        },
        // 生活休闲类
        18: {
          id: 18,
          title: '美食制作大全',
          author: '王刚',
          publisher: '中国轻工业出版社',
          originalPrice: 48.00,
          price: 36.00,
          cover: 'images/book-03-188x246.jpg',
          category: 'life'
        },
        19: {
          id: 19,
          title: '瑜伽入门指南',
          author: '张蕙兰',
          publisher: '人民体育出版社',
          originalPrice: 42.00,
          price: 32.00,
          cover: 'images/book-04-188x246.jpg',
          category: 'life'
        },
        20: {
          id: 20,
          title: '家居装修设计',
          author: '梁志天',
          publisher: '中国建筑工业出版社',
          originalPrice: 68.00,
          price: 52.00,
          cover: 'images/book-05-188x246.jpg',
          category: 'life'
        },
        // 社会科学类
        21: {
          id: 21,
          title: '社会心理学',
          author: '戴维·迈尔斯',
          publisher: '人民邮电出版社',
          originalPrice: 78.00,
          price: 58.00,
          cover: 'images/book-06-188x246.jpg',
          category: 'social'
        },
        22: {
          id: 22,
          title: '经济学原理',
          author: '曼昆',
          publisher: '北京大学出版社',
          originalPrice: 88.00,
          price: 68.00,
          cover: 'images/book-07-188x246.jpg',
          category: 'social'
        },
        23: {
          id: 23,
          title: '法理学概论',
          author: '张文显',
          publisher: '法律出版社',
          originalPrice: 56.00,
          price: 42.00,
          cover: 'images/book-08-188x246.jpg',
          category: 'social'
        }
      };

      // 获取URL参数中的分类信息
      const urlParams = new URLSearchParams(window.location.search);
      const category = urlParams.get('type');

      // 根据分类加载对应的图书
      async function loadBooks(filterCategory = null) {
        console.log('📚 开始加载图书，分类:', filterCategory);

        const booksContainer = document.getElementById('booksContainer');
        const bookCountElement = document.getElementById('bookCount');

        // 显示加载状态
        booksContainer.innerHTML = `
          <div class="col-12 text-center">
            <div class="loading-state">
              <div style="font-size: 48px; margin-bottom: 20px;">📚</div>
              <h4>正在加载图书...</h4>
            </div>
          </div>
        `;
        bookCountElement.textContent = '正在加载图书...';

        try {
          // 分类映射：前端代码 -> 数据库分类名称
          const categoryMapping = {
            'business': '商业管理',
            'technology': '计算机技术',
            'literature': '文学艺术',
            'education': '教育考试',
            'children': '少儿读物',
            'life': '生活休闲',
            'social': '社会科学'
          };

          // 构建API请求URL
          let apiUrl = 'http://1.94.203.175:5000/api/book/';
          const params = new URLSearchParams();

          if (filterCategory) {
            // 将前端分类代码转换为数据库分类名称
            const dbCategoryName = categoryMapping[filterCategory] || filterCategory;
            params.append('category', dbCategoryName);
            console.log('🔄 分类映射:', filterCategory, '->', dbCategoryName);
          }

          if (params.toString()) {
            apiUrl += '?' + params.toString();
          }

          console.log('📡 请求API:', apiUrl);

          const response = await fetch(apiUrl);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();
          console.log('📦 API响应:', result);

          if (!result.success || !result.data || !result.data.books) {
            throw new Error('API响应格式错误');
          }

          const books = result.data.books;
          console.log('📚 获取到图书:', books.length, '本');

          if (books.length === 0) {
            booksContainer.innerHTML = `
              <div class="col-12 text-center">
                <div class="empty-category">
                  <div style="font-size: 48px; margin-bottom: 20px;">📚</div>
                  <h4>暂无图书</h4>
                  <p style="color: #666;">该分类下暂时没有图书，请查看其他分类。</p>
                </div>
              </div>
            `;
            bookCountElement.textContent = '暂无图书';
            updatePageTitle(filterCategory, 0);
            return;
          }

          // 更新图书列表
          booksContainer.innerHTML = books.map(book => {
            const currentPrice = book.currentPrice || book.current_price || 0;
            const originalPrice = book.originalPrice || book.original_price || currentPrice;
            const stockQuantity = book.stockQuantity || book.stock_quantity || 0;
            const coverImage = book.coverImageUrl || book.cover_image_url || 'images/default-book.svg';

            return `
              <div class="col-sm-6 col-md-4">
                <div class="product novi-background">
                  <div class="product-image">
                    <a href="book-detail.html?id=${book.id}"><img src="${coverImage}" alt="${book.title}" width="220" height="280" onerror="this.src='images/default-book.svg'"/></a>
                    <div class="product-overlay">
                      <div class="product-actions">
                        <a class="mdi mdi-cart product-btn" href="#" onclick="addToCart(${book.id})"></a>
                        <a class="mdi mdi-heart product-btn" href="#" onclick="addToFavorites(${book.id})"></a>
                      </div>
                    </div>
                  </div>
                  <div class="product-title">
                    <h5><a href="book-detail.html?id=${book.id}">${book.title}</a></h5>
                    <p class="product-author">${book.author} 著</p>
                  </div>
                  <div class="product-price">
                    <div class="product-price-old">￥${originalPrice.toFixed(2)}</div>
                    <div class="product-price-new">￥${currentPrice.toFixed(2)}</div>
                  </div>
                  <div class="product-stock ${stockQuantity > 0 ? 'in-stock' : 'out-of-stock'}">
                    ${stockQuantity > 0 ? `库存：${stockQuantity}本` : '暂时缺货'}
                  </div>
                </div>
              </div>
            `;
          }).join('');

          // 更新页面标题
          updatePageTitle(filterCategory, books.length);

          // 更新图书计数
          bookCountElement.textContent = `共显示 ${books.length} 本图书`;

        } catch (error) {
          console.error('❌ 加载图书失败:', error);

          booksContainer.innerHTML = `
            <div class="col-12 text-center">
              <div class="error-state">
                <div style="font-size: 48px; margin-bottom: 20px;">❌</div>
                <h4>加载失败</h4>
                <p style="color: #666;">无法加载图书数据，请稍后重试。</p>
                <button class="button button-primary" onclick="loadBooks('${filterCategory || ''}')">重新加载</button>
              </div>
            </div>
          `;
          bookCountElement.textContent = '加载失败';
          updatePageTitle(filterCategory, 0);
        }
      }

      // 更新页面标题
      function updatePageTitle(filterCategory, bookCount) {
        const categoryNames = {
          'business': '商业管理',
          'technology': '科技计算机',
          'literature': '文学艺术',
          'education': '教育考试',
          'children': '少儿读物',
          'life': '生活休闲',
          'social': '社会科学'
        };

        const titleElement = document.querySelector('.breadcrumbs-custom-title');
        const subtitleElement = document.querySelector('.breadcrumbs-custom-subtitle');

        if (filterCategory && categoryNames[filterCategory]) {
          titleElement.textContent = categoryNames[filterCategory];
          subtitleElement.textContent = `共找到 ${bookCount} 本图书`;
        } else {
          titleElement.textContent = '全部图书';
          subtitleElement.textContent = `共 ${bookCount} 本图书`;
        }
      }

      // 添加购物车（真实功能）
      async function addToCart(bookId) {
        console.log('🛒 添加到购物车，图书ID:', bookId);

        // 检查登录状态
        const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!authToken) {
          alert('请先登录后再添加商品到购物车');
          window.location.href = 'login-page.html';
          return;
        }

        const output = document.getElementById('form-output-global');

        try {
          // 显示加载状态
          if (output) {
            output.innerHTML = '<div class="alert alert-info">正在添加到购物车...</div>';
            output.style.display = 'block';
          }

          const response = await fetch('http://1.94.203.175:5000/api/order/cart/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
              bookId: parseInt(bookId),
              quantity: 1
            })
          });

          if (response.ok) {
            const result = await response.json();
            console.log('✅ 添加到购物车成功:', result);

            if (output) {
              output.innerHTML = `<div class="alert alert-success">图书已成功添加到购物车！</div>`;
              setTimeout(() => {
                output.style.display = 'none';
              }, 3000);
            }

            // 更新购物车计数
            updateCartCount();
          } else {
            const errorResult = await response.json();
            console.error('❌ 添加到购物车失败:', errorResult);

            if (output) {
              output.innerHTML = `<div class="alert alert-danger">添加失败: ${errorResult.message || '请稍后重试'}</div>`;
              setTimeout(() => {
                output.style.display = 'none';
              }, 3000);
            }
          }
        } catch (error) {
          console.error('❌ 添加到购物车时发生错误:', error);

          if (output) {
            output.innerHTML = `<div class="alert alert-danger">添加失败: ${error.message}</div>`;
            setTimeout(() => {
              output.style.display = 'none';
            }, 3000);
          }
        }
      }

      // 添加收藏（简化版）
      function addToFavorites(bookId) {
        const book = booksDatabase[bookId];
        if (book) {
          const output = document.getElementById('form-output-global');
          output.innerHTML = `<div class="alert alert-success">《${book.title}》已添加到收藏！</div>`;
          output.style.display = 'block';
          setTimeout(() => {
            output.style.display = 'none';
          }, 3000);
        }
      }

      // 分类筛选
      document.querySelectorAll('.list-categories a').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          // 移除所有active类
          document.querySelectorAll('.list-categories a').forEach(a => a.classList.remove('active'));
          // 添加active类到当前链接
          this.classList.add('active');

          // 获取分类
          const url = new URL(this.href);
          const categoryType = url.searchParams.get('type');

          // 加载对应分类的图书
          loadBooks(categoryType);
        });
      });

      // 初始加载
      if (category) {
        // 如果有分类参数，加载对应分类
        loadBooks(category);
        // 更新侧边栏active状态
        document.querySelectorAll('.list-categories a').forEach(link => {
          const url = new URL(link.href);
          if (url.searchParams.get('type') === category) {
            link.classList.add('active');
          } else {
            link.classList.remove('active');
          }
        });
      } else {
        // 没有分类参数，显示所有图书
        loadBooks();
      }

      // 用户状态管理
      function checkUserStatus() {
        console.log('🔍 检查用户状态');

        const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const userInfoStr = localStorage.getItem('userInfo');
        const username = localStorage.getItem('username');

        console.log('登录数据:', { authToken: !!authToken, isLoggedIn, userInfoStr: !!userInfoStr, username });

        const userMenu = document.getElementById('userMenu');
        const userDisplayName = document.getElementById('userDisplayName');
        const userDropdown = document.getElementById('userDropdown');

        if (!userMenu || !userDisplayName) {
          console.error('❌ 用户菜单元素未找到');
          return;
        }

        let userInfo = {};
        if (userInfoStr) {
          try {
            userInfo = JSON.parse(userInfoStr);
          } catch (error) {
            console.error('❌ 解析用户信息失败:', error);
          }
        }

        // 检查是否已登录（简化检查逻辑）
        const hasValidLogin = (
          (authToken && authToken !== 'null') &&
          (isLoggedIn === 'true') &&
          (userInfo.username || username)
        );

        console.log('登录状态详细检查:');
        console.log('  authToken:', authToken);
        console.log('  authToken有效:', authToken && authToken !== 'null');
        console.log('  isLoggedIn:', isLoggedIn);
        console.log('  isLoggedIn为true:', isLoggedIn === 'true');
        console.log('  userInfo.username:', userInfo.username);
        console.log('  username:', username);
        console.log('  有用户名:', !!(userInfo.username || username));
        console.log('最终登录状态判断:', hasValidLogin);

        if (hasValidLogin) {
          // 用户已登录
          const displayName = userInfo.username || username || '用户';
          console.log('✅ 用户已登录:', displayName);

          userDisplayName.textContent = displayName;
          userMenu.href = '#';

          // 不在这里绑定事件，避免与addEventListener冲突
          // 事件处理由DOMContentLoaded中的addEventListener统一管理
        } else {
          // 备用检查：如果主要检查失败，但有基本的登录数据，仍然显示为已登录
          const hasBasicLogin = (authToken && authToken !== 'null') || (isLoggedIn === 'true');
          const fallbackUsername = userInfo.username || username || localStorage.getItem('username');

          if (hasBasicLogin && fallbackUsername) {
            console.log('⚠️ 备用登录检查通过，显示用户名:', fallbackUsername);
            userDisplayName.textContent = fallbackUsername;
            userMenu.href = '#';
          } else {
            // 用户未登录
            console.log('❌ 用户未登录');
            userDisplayName.textContent = '登录';
            userMenu.href = 'login-page.html';

            if (userDropdown) {
              userDropdown.style.display = 'none';
            }
          }
        }
      }

      // 退出登录函数
      function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('token');
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('userInfo');
        localStorage.removeItem('username');
        localStorage.removeItem('userEmail');

        alert('已退出登录');
        checkUserStatus();
        window.location.href = 'login-page.html';
      }

      // 页面加载时检查用户状态和设置用户菜单交互
      document.addEventListener('DOMContentLoaded', function() {
        checkUserStatus();

        // 用户菜单点击事件
        const userMenu = document.getElementById('userMenu');
        const userDropdown = document.getElementById('userDropdown');

        if (userMenu && userDropdown) {
          userMenu.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            // 检查用户是否已登录
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');

            if (isLoggedIn && authToken && authToken !== 'null') {
              // 用户已登录，切换下拉菜单显示状态
              console.log('🖱️ 用户菜单被点击 - 已登录状态');
              if (userDropdown.style.display === 'none' || userDropdown.style.display === '') {
                userDropdown.style.display = 'block';
                console.log('📖 显示用户下拉菜单');
              } else {
                userDropdown.style.display = 'none';
                console.log('📕 隐藏用户下拉菜单');
              }
            } else {
              // 用户未登录，跳转到登录页面
              console.log('🖱️ 用户菜单被点击 - 未登录状态，跳转登录页面');
              window.location.href = 'login-page.html';
            }
          });

          // 点击页面其他地方关闭下拉菜单
          document.addEventListener('click', function(e) {
            if (!userMenu.contains(e.target) && !userDropdown.contains(e.target)) {
              userDropdown.style.display = 'none';
            }
          });
        }
      });

      // 如果页面已经加载完成，立即检查
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkUserStatus);
      } else {
        checkUserStatus();
      }

      // 更新购物车计数
      async function updateCartCount() {
        const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!authToken) {
          // 未登录时显示0
          const cartCount = document.getElementById('cartCount');
          if (cartCount) {
            cartCount.textContent = '0';
          }
          return;
        }

        try {
          const response = await fetch('http://1.94.203.175:5000/api/order/cart', {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });

          if (response.ok) {
            const result = await response.json();
            const cartCount = document.getElementById('cartCount');
            if (cartCount && result.data && result.data.items) {
              const totalItems = result.data.items.reduce((sum, item) => sum + item.quantity, 0);
              cartCount.textContent = totalItems;
              console.log('✅ 购物车计数已更新:', totalItems);
            }
          } else {
            console.log('⚠️ 获取购物车数据失败');
          }
        } catch (error) {
          console.error('❌ 更新购物车计数失败:', error);
          // 出错时也显示0
          const cartCount = document.getElementById('cartCount');
          if (cartCount) {
            cartCount.textContent = '0';
          }
        }
      }

      // 页面加载时更新购物车计数
      document.addEventListener('DOMContentLoaded', function() {
        updateCartCount();
      });

      // 延迟检查，确保所有数据都已加载
      setTimeout(checkUserStatus, 1000);
      setTimeout(checkUserStatus, 3000);
      setTimeout(updateCartCount, 2000);
      setTimeout(updateCartCount, 5000);
    </script>
  </body>
</html>