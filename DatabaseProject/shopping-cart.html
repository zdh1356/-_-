<!DOCTYPE html>
<html class="wide wow-animation" lang="zh-CN">
  <head>
    <!-- Site Title-->
    <title>è´­ç‰©è½¦ - åè½©ä¹¦åº—</title>
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <!-- Stylesheets-->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:700%7CLato:300,400,300italic,700">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fonts.css">
    <!-- å®æ—¶æ•°æ®ç³»ç»Ÿæ ·å¼ -->
    <link rel="stylesheet" href="css/realtime-ui.css">
    <style>
      /* è´­ç‰©è½¦é¡µé¢ç”¨æˆ·èœå•æ ·å¼ */
      .rd-navbar-user {
        position: relative;
      }

      .user-icon {
        display: flex;
        align-items: center;
        gap: 5px;
        color: #333;
        text-decoration: none;
        padding: 8px 12px;
        border-radius: 4px;
        transition: background-color 0.3s;
        cursor: pointer;
      }

      .user-icon:hover {
        background-color: #f5f5f5;
        text-decoration: none;
        color: #007bff;
      }

      .user-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        min-width: 150px;
        z-index: 1000;
        display: none;
      }

      .user-dropdown a {
        display: block;
        padding: 10px 15px;
        color: #333;
        text-decoration: none;
        border-bottom: 1px solid #eee;
      }

      .user-dropdown a:hover {
        background: #f5f5f5;
        color: #007bff;
      }

      .user-dropdown a:last-child {
        border-bottom: none;
      }

      /* è´­ç‰©è½¦å’Œç”¨æˆ·å›¾æ ‡å¯¹é½è°ƒæ•´ */
      .rd-navbar-user,
      .rd-navbar-cart {
        display: flex;
        align-items: center;
      }

      .rd-navbar-cart .cart-icon {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 4px;
        color: #333;
        text-decoration: none;
        transition: background-color 0.3s ease;
        position: relative;
      }

      .rd-navbar-cart .cart-icon:hover {
        background-color: #f5f5f5;
        text-decoration: none;
        color: #333;
      }

      .cart-count {
        background: #dc3545;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
        font-weight: bold;
        min-width: 18px;
        text-align: center;
        line-height: 1.2;
      }

      /* å›¾æ ‡å¤§å°è°ƒæ•´ */
      .rd-navbar-user .mdi,
      .rd-navbar-cart .mdi {
        font-size: 20px;
        line-height: 1;
      }

      /* æ•°é‡æ§åˆ¶æŒ‰é’®æ ·å¼ */
      .quantity-controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .quantity-btn {
        background: #007bff;
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease;
      }

      .quantity-btn:hover {
        background: #0056b3;
      }

      .quantity-display {
        min-width: 40px;
        text-align: center;
        font-weight: bold;
        font-size: 16px;
        padding: 5px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #f8f9fa;
      }
    </style>
		<!--[if lt IE 10]>
    <div style="background: #212121; padding: 10px 0; box-shadow: 3px 3px 5px 0 rgba(0,0,0,.3); clear: both; text-align:center; position: relative; z-index:1;"><a href="http://windows.microsoft.com/en-US/internet-explorer/"><img src="images/ie8-panel/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="æ‚¨æ­£åœ¨ä½¿ç”¨è¿‡æ—¶çš„æµè§ˆå™¨ã€‚ä¸ºäº†è·å¾—æ›´å¿«æ›´å®‰å…¨çš„æµè§ˆä½“éªŒï¼Œè¯·å…è´¹å‡çº§ã€‚"></a></div>
    <script src="js/html5shiv.min.js"></script>
		<![endif]-->
  </head>
  <body>
    <!-- Page preloader-->
    <div class="page-loader">
      <div class="page-loader-body">
        <div class="preloader-wrapper big active">
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"> </div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Page-->
    <div class="page">
      <!-- Page Header-->
      <header class="section page-header">
        <!-- RD Navbar-->
        <div class="rd-navbar-wrap rd-navbar-centered">
          <nav class="rd-navbar novi-background" data-layout="rd-navbar-fixed" data-sm-layout="rd-navbar-fixed" data-md-layout="rd-navbar-fixed" data-md-device-layout="rd-navbar-fixed" data-lg-layout="rd-navbar-fullwidth" data-lg-device-layout="rd-navbar-fixed" data-xl-layout="rd-navbar-static" data-xl-device-layout="rd-navbar-static" data-md-stick-up-offset="1px" data-lg-stick-up-offset="1px" data-stick-up="true" data-sm-stick-up="true" data-md-stick-up="true" data-lg-stick-up="true" data-xl-stick-up="true">
            <div class="rd-navbar-inner">
              <div class="rd-navbar-aside-left">
                <div class="rd-navbar-nav-wrap">
                  <!-- RD Navbar Nav-->
                  <ul class="rd-navbar-nav">
                    <li><a href="index.html">é¦–é¡µ</a></li>
                    <li><a href="#">å›¾ä¹¦åˆ†ç±»</a>
                      <!-- RD Navbar Dropdown-->
                      <ul class="rd-navbar-dropdown">
                        <li><a href="category.html?type=business">å•†ä¸šç®¡ç†</a></li>
                        <li><a href="category.html?type=technology">ç§‘æŠ€è®¡ç®—æœº</a></li>
                        <li><a href="category.html?type=literature">æ–‡å­¦è‰ºæœ¯</a></li>
                        <li><a href="category.html?type=education">æ•™è‚²è€ƒè¯•</a></li>
                        <li><a href="category.html?type=children">å°‘å„¿è¯»ç‰©</a></li>
                        <li><a href="category.html?type=life">ç”Ÿæ´»ä¼‘é—²</a></li>
                        <li><a href="category.html?type=social">ç¤¾ä¼šç§‘å­¦</a></li>
                      </ul>
                    </li>
                    <li><a href="recommendations.html">ä¸ºæ‚¨æ¨è</a></li>
                    <li><a href="forum.html">è¯»è€…è®ºå›</a></li>
                  </ul>
                </div>
              </div>
              <!-- RD Navbar Panel-->
              <div class="rd-navbar-panel">
                <button class="rd-navbar-toggle" data-rd-navbar-toggle=".rd-navbar-nav-wrap"><span></span></button>
                <!-- RD Navbar Brand-->
                <div class="rd-navbar-brand"><a class="brand-name" href="index.html"><img class="logo-default" src="images/logo-default-161x57.png" alt="åè½©ä¹¦åº—" width="161" height="57"/><img class="logo-inverse" src="images/logo-inverse-161x57.png" alt="åè½©ä¹¦åº—" width="161" height="57"/></a></div>
              </div>
              <div class="rd-navbar-collapse-toggle" data-rd-navbar-toggle=".rd-navbar-collapse"><span></span></div>
              <div class="rd-navbar-aside-right rd-navbar-collapse">
                <!-- RD Navbar Search-->
                <div class="rd-navbar-search"><a class="rd-navbar-search-toggle" data-rd-navbar-toggle=".rd-navbar-search" href="#"><span></span></a>
                  <form class="rd-search" action="search.html" data-search-live="rd-search-results-live" method="GET">
                    <div class="form-wrap">
                      <label class="form-label form-label" for="rd-navbar-search-form-input">æœç´¢å›¾ä¹¦...</label>
                      <input class="rd-navbar-search-form-input form-input" id="rd-navbar-search-form-input" type="text" name="keyword" autocomplete="off">
                      <div class="rd-search-results-live"></div>
                    </div>
                    <button class="rd-search-form-submit mdi mdi-magnify"></button>
                  </form>
                </div>
                <!-- User Menu -->
                <div class="rd-navbar-user">
                  <a href="login-page.html" class="user-icon" id="userMenu">
                    <i class="mdi mdi-account"></i>
                    <span id="userDisplayName">ç™»å½•</span>
                  </a>
                  <div class="user-dropdown" id="userDropdown" style="display: none;">
                    <a href="user-profile.html">ä¸ªäººèµ„æ–™</a>
                    <a href="order-history.html">æˆ‘çš„è®¢å•</a>
                    <a href="browsing-history.html">æµè§ˆå†å²</a>
                    <a href="user-preferences.html">åå¥½è®¾ç½®</a>
                    <a href="change-password.html">ä¿®æ”¹å¯†ç </a>
                    <a href="#" onclick="logout()">é€€å‡ºç™»å½•</a>
                  </div>
                </div>
                <!-- Shopping Cart -->
                <div class="rd-navbar-cart">
                  <a href="shopping-cart.html" class="cart-icon" id="cartIcon">
                    <i class="mdi mdi-cart"></i>
                    <span class="cart-count" id="cartCount">0</span>
                  </a>
                </div>
              </div>
            </div>
          </nav>
        </div>
      </header>
      <!-- Breadcrumbs-->
      <section class="breadcrumbs-custom" style="background-image: url(images/breadcrumbs-bg.jpg)">
        <div class="container">
          <p class="breadcrumbs-custom-subtitle">æˆ‘çš„è´­ç‰©è½¦</p>
          <p class="heading-1 breadcrumbs-custom-title">è´­ç‰©è½¦</p>
          <ul class="breadcrumbs-custom-path">
            <li><a href="index.html">é¦–é¡µ</a></li>
            <li class="active">è´­ç‰©è½¦</li>
          </ul>
        </div>
      </section>

      <!-- Shopping Cart-->
      <section class="section section-lg bg-default">
        <div class="container">
          <div class="row">
            <div class="col-12">
              <!-- Shopping Cart Table-->
              <div class="table-responsive">
                <table class="table table-cart">
                  <thead>
                    <tr>
                      <th>
                        <div class="checkbox-inline">
                          <label>
                            <input type="checkbox" id="selectAll">
                            <span class="checkbox-inline__box"></span>
                          </label>
                        </div>
                      </th>
                      <th>å›¾ä¹¦ä¿¡æ¯</th>
                      <th>å•ä»·</th>
                      <th>æ•°é‡</th>
                      <th>å°è®¡</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="cartItems">
                    <!-- Cart items will be loaded here -->
                  </tbody>
                </table>
              </div>
              <!-- Cart Actions-->
              <div class="row align-items-center" style="margin-top: 20px;">
                <div class="col-md-6">
                  <div style="display: flex; align-items: flex-end;">
                    <button class="button button-primary" id="clearCart" style="margin-right: 15px; width: 120px; height: 48px; display: flex; align-items: center; justify-content: center;">æ¸…ç©ºè´­ç‰©è½¦</button>
                    <button class="button button-primary" id="continueShop" style="width: 120px; height: 48px; display: flex; align-items: center; justify-content: center;">ç»§ç»­è´­ç‰©</button>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="cart-total text-right d-flex align-items-center justify-content-end">
                    <span>å·²é€‰æ‹© <span id="selectedCount">0</span> ä»¶å•†å“</span>
                    <span style="margin-left: 20px;">åˆè®¡ï¼šï¿¥<span id="totalPrice">0.00</span></span>
                    <button class="button button-secondary" onclick="testCheckboxes()" style="margin-left: 20px; min-width: 80px; height: 48px; padding: 12px 15px;">æµ‹è¯•</button>
                    <button class="button button-primary" id="checkout" style="margin-left: 10px; min-width: 100px; height: 48px; padding: 12px 20px;">ç»“ç®—</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Recommended Books-->
      <section class="section section-lg bg-gray-lighter">
        <div class="container">
          <h3>çŒœä½ å–œæ¬¢</h3>
          <div class="row row-30" id="recommendedBooks">
            <!-- Recommended books will be loaded here -->
          </div>
        </div>
      </section>
    </div>
    <!-- Global Mailform Output-->
    <div class="snackbars" id="form-output-global"></div>
    <!-- Javascript-->
    <script src="js/core.min.js"></script>
    <script src="js/script.js"></script>

    <!-- å®æ—¶æ•°æ®ç³»ç»Ÿè„šæœ¬ -->
    <script src="js/realtime-data-manager.js"></script>
    <script src="js/page-adapters.js"></script>

    <!-- è´­ç‰©è½¦é¡µé¢ç”¨æˆ·çŠ¶æ€ç®¡ç† -->
    <script>
      // è´­ç‰©è½¦é¡µé¢ç”¨æˆ·çŠ¶æ€æ£€æŸ¥
      function checkCartUserStatus() {
        console.log('ğŸ” æ£€æŸ¥ç”¨æˆ·çŠ¶æ€ - è´­ç‰©è½¦é¡µé¢');

        const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const userInfoStr = localStorage.getItem('userInfo');
        const username = localStorage.getItem('username');

        console.log('ç™»å½•æ•°æ®:', { authToken: !!authToken, isLoggedIn, userInfoStr: !!userInfoStr, username });

        const userMenu = document.getElementById('userMenu');
        const userDisplayName = document.getElementById('userDisplayName');
        const userDropdown = document.getElementById('userDropdown');

        if (!userMenu || !userDisplayName) {
          console.error('âŒ è´­ç‰©è½¦é¡µé¢ç”¨æˆ·èœå•å…ƒç´ æœªæ‰¾åˆ°');
          return;
        }

        let userInfo = {};
        if (userInfoStr) {
          try {
            userInfo = JSON.parse(userInfoStr);
          } catch (error) {
            console.error('âŒ è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
          }
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆå¤šé‡æ£€æŸ¥ï¼‰
        const hasValidLogin = (
          (authToken && authToken !== 'null') &&
          (isLoggedIn === 'true') &&
          (userInfo.username || username)
        );

        console.log('ç™»å½•çŠ¶æ€åˆ¤æ–­:', hasValidLogin);

        if (hasValidLogin) {
          // ç”¨æˆ·å·²ç™»å½•
          const displayName = userInfo.username || username || 'ç”¨æˆ·';
          console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', displayName);

          userDisplayName.textContent = displayName;
          userMenu.href = '#';

          // ç»‘å®šä¸‹æ‹‰èœå•äº‹ä»¶
          userMenu.onclick = function(e) {
            e.preventDefault();
            if (userDropdown) {
              const isHidden = userDropdown.style.display === 'none' || !userDropdown.style.display;
              userDropdown.style.display = isHidden ? 'block' : 'none';
            }
          };
        } else {
          // ç”¨æˆ·æœªç™»å½•
          console.log('âŒ ç”¨æˆ·æœªç™»å½•');
          userDisplayName.textContent = 'ç™»å½•';
          userMenu.href = 'login-page.html';
          userMenu.onclick = null;

          if (userDropdown) {
            userDropdown.style.display = 'none';
          }
        }
      }

      // æ³¨é”€åŠŸèƒ½
      function logout() {
        if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
          console.log('ğŸšª è´­ç‰©è½¦é¡µé¢ç”¨æˆ·æ³¨é”€');
          localStorage.removeItem('userInfo');
          localStorage.removeItem('authToken');
          localStorage.removeItem('token');
          localStorage.removeItem('cart');

          // è·³è½¬åˆ°é¦–é¡µ
          window.location.href = 'index.html';
        }
      }

      // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç”¨æˆ·çŠ¶æ€å’ŒåŠ è½½è´­ç‰©è½¦æ•°æ®
      document.addEventListener('DOMContentLoaded', function() {
        checkCartUserStatus();
        loadCartData();

        // ç»‘å®šç»“ç®—æŒ‰é’®äº‹ä»¶
        const checkoutButton = document.getElementById('checkout');
        if (checkoutButton) {
          checkoutButton.addEventListener('click', proceedToCheckout);
        }

        // ç»‘å®šå…¨é€‰åŠŸèƒ½ï¼ˆåˆå§‹ç»‘å®šï¼‰
        const selectAllCheckbox = document.getElementById('selectAll');
        if (selectAllCheckbox) {
          selectAllCheckbox.addEventListener('change', handleSelectAll);
          console.log('ğŸ”— åˆå§‹å…¨é€‰å¤é€‰æ¡†äº‹ä»¶å·²ç»‘å®š');
        }
      });

      // ç›‘å¬å­˜å‚¨å˜åŒ–
      window.addEventListener('storage', function(e) {
        if (e.key === 'authToken' || e.key === 'token' || e.key === 'userInfo') {
          console.log('ğŸ’¾ è´­ç‰©è½¦é¡µé¢æ£€æµ‹åˆ°å­˜å‚¨å˜åŒ–ï¼Œæ›´æ–°ç”¨æˆ·çŠ¶æ€');
          checkCartUserStatus();
        }
      });

      // åŠ è½½è´­ç‰©è½¦æ•°æ®
      async function loadCartData() {
        const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!authToken) {
          displayEmptyCart();
          return;
        }

        try {
          const response = await fetch('http://1.94.203.175:5000/api/order/cart', {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });

          if (response.ok) {
            const result = await response.json();
            if (result.data && result.data.items && result.data.items.length > 0) {
              displayCartItems(result.data.items);
            } else {
              displayEmptyCart();
            }
          } else {
            displayEmptyCart();
          }
        } catch (error) {
          console.error('åŠ è½½è´­ç‰©è½¦æ•°æ®å¤±è´¥:', error);
          displayEmptyCart();
        }
      }

      // æ˜¾ç¤ºè´­ç‰©è½¦å•†å“
      function displayCartItems(items) {
        const cartContainer = document.getElementById('cartItems');
        if (!cartContainer) {
          console.error('âŒ è´­ç‰©è½¦å®¹å™¨æœªæ‰¾åˆ°');
          return;
        }

        let totalPrice = 0;
        let totalItems = 0;

        const cartHTML = items.map(item => {
          console.log('ğŸ›’ å¤„ç†è´­ç‰©è½¦å•†å“:', item);

          // ä»æ•°æ®åº“è¿”å›çš„å®Œæ•´å›¾ä¹¦ä¿¡æ¯
          const book = item.book || {};
          const title = book.title || item.title || 'æœªçŸ¥å›¾ä¹¦';
          const author = book.author || item.author || 'æœªçŸ¥ä½œè€…';
          const publisher = book.publisher || item.publisher || 'æœªçŸ¥å‡ºç‰ˆç¤¾';
          const price = parseFloat(book.currentPrice || item.price || 0);
          const coverImage = book.coverImageUrl || item.cover || 'images/default-book.svg';
          const quantity = parseInt(item.quantity || 1);
          const itemTotal = price * quantity;

          totalPrice += itemTotal;
          totalItems += quantity;

          return `
            <tr>
              <td>
                <div class="checkbox-inline">
                  <label>
                    <input type="checkbox" class="item-checkbox" data-book-id="${item.bookId}" data-item-id="${item.id}">
                    <span class="checkbox-inline__box"></span>
                  </label>
                </div>
              </td>
              <td>
                <div class="product-cart">
                  <div class="product-cart-img">
                    <img src="${coverImage}" alt="${title}" width="80" height="100">
                  </div>
                  <div class="product-cart-info">
                    <h6>${title}</h6>
                    <p>ä½œè€…: ${author}</p>
                    <p>å‡ºç‰ˆç¤¾: ${publisher}</p>
                  </div>
                </div>
              </td>
              <td>ï¿¥${price.toFixed(2)}</td>
              <td>
                <div class="quantity-controls">
                  <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${Math.max(1, quantity - 1)})">-</button>
                  <span class="quantity-display">${quantity}</span>
                  <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${quantity + 1})">+</button>
                </div>
              </td>
              <td>ï¿¥${itemTotal.toFixed(2)}</td>
              <td>
                <button class="button button-sm button-secondary" onclick="removeFromCart(${item.id})">åˆ é™¤</button>
              </td>
            </tr>
          `;
        }).join('');

        cartContainer.innerHTML = cartHTML;
        console.log('âœ… è´­ç‰©è½¦HTMLå·²æ’å…¥');

        // å»¶è¿Ÿç»‘å®šäº‹ä»¶ï¼Œç¡®ä¿DOMæ›´æ–°å®Œæˆ
        setTimeout(() => {
          // ä¸ºå¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
          const itemCheckboxes = document.querySelectorAll('.item-checkbox');
          console.log('ğŸ”— æ‰¾åˆ°å¤é€‰æ¡†æ•°é‡:', itemCheckboxes.length);

          itemCheckboxes.forEach((checkbox, index) => {
            console.log(`ğŸ”— ç»‘å®šå¤é€‰æ¡† ${index + 1} äº‹ä»¶ï¼ŒbookId:`, checkbox.getAttribute('data-book-id'));
            checkbox.addEventListener('change', function() {
              console.log('âœ… å¤é€‰æ¡†çŠ¶æ€æ”¹å˜:', this.checked, 'bookId:', this.getAttribute('data-book-id'));
              updateCartSummary();
            });
          });

          // é‡æ–°ç»‘å®šå…¨é€‰åŠŸèƒ½
          const selectAllCheckbox = document.getElementById('selectAll');
          if (selectAllCheckbox) {
            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            selectAllCheckbox.removeEventListener('change', handleSelectAll);
            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            selectAllCheckbox.addEventListener('change', handleSelectAll);
            console.log('ğŸ”— å…¨é€‰å¤é€‰æ¡†äº‹ä»¶å·²é‡æ–°ç»‘å®š');
          }
        }, 100);

        // æ›´æ–°æ€»è®¡æ˜¾ç¤ºï¼ˆæ˜¾ç¤ºæ‰€æœ‰å•†å“çš„æ€»è®¡ï¼‰
        const selectedCountElement = document.getElementById('selectedCount');
        const totalPriceElement = document.getElementById('totalPrice');

        if (selectedCountElement) {
          selectedCountElement.textContent = '0'; // åˆå§‹ä¸º0ï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
        }
        if (totalPriceElement) {
          totalPriceElement.textContent = '0.00'; // åˆå§‹ä¸º0ï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
        }
      }

      // æ˜¾ç¤ºç©ºè´­ç‰©è½¦
      function displayEmptyCart() {
        const cartContainer = document.getElementById('cartItems');
        if (!cartContainer) {
          console.error('âŒ è´­ç‰©è½¦å®¹å™¨æœªæ‰¾åˆ°');
          return;
        }

        cartContainer.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 50px;">
              <div class="empty-cart">
                <div style="font-size: 48px; margin-bottom: 20px;">ğŸ›’</div>
                <h4>è´­ç‰©è½¦æ˜¯ç©ºçš„</h4>
                <p style="color: #666; margin: 20px 0;">å¿«å»æŒ‘é€‰æ‚¨å–œæ¬¢çš„å›¾ä¹¦å§ï¼</p>
                <a href="category.html" class="button button-primary">å»è´­ç‰©</a>
              </div>
            </td>
          </tr>
        `;

        // é‡ç½®æ€»è®¡æ˜¾ç¤º
        const selectedCountElement = document.getElementById('selectedCount');
        const totalPriceElement = document.getElementById('totalPrice');

        if (selectedCountElement) {
          selectedCountElement.textContent = '0';
        }
        if (totalPriceElement) {
          totalPriceElement.textContent = '0.00';
        }
      }

      // æ›´æ–°å•†å“æ•°é‡
      async function updateQuantity(itemId, newQuantity) {
        if (newQuantity < 1) {
          removeFromCart(itemId);
          return;
        }

        const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!authToken) {
          alert('è¯·å…ˆç™»å½•');
          return;
        }

        try {
          const response = await fetch('http://1.94.203.175:5000/api/order/cart/update', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
              itemId: itemId,
              quantity: newQuantity
            })
          });

          if (response.ok) {
            loadCartData(); // é‡æ–°åŠ è½½è´­ç‰©è½¦æ•°æ®
          } else {
            const result = await response.json();
            alert(result.message || 'æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        } catch (error) {
          console.error('æ›´æ–°æ•°é‡å¤±è´¥:', error);
          alert('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      }

      // ä»è´­ç‰©è½¦åˆ é™¤å•†å“
      async function removeFromCart(itemId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä»¶å•†å“å—ï¼Ÿ')) {
          return;
        }

        const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!authToken) {
          alert('è¯·å…ˆç™»å½•');
          return;
        }

        try {
          const response = await fetch(`http://1.94.203.175:5000/api/order/cart/remove?itemId=${itemId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });

          if (response.ok) {
            loadCartData(); // é‡æ–°åŠ è½½è´­ç‰©è½¦æ•°æ®
          } else {
            const result = await response.json();
            alert(result.message || 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        } catch (error) {
          console.error('åˆ é™¤å•†å“å¤±è´¥:', error);
          alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      }

      // å»ç»“ç®—
      function proceedToCheckout() {
        console.log('ğŸ›’ å¼€å§‹ç»“ç®—æµç¨‹');

        // å…ˆæ£€æŸ¥æ‰€æœ‰å¤é€‰æ¡†
        const allCheckboxes = document.querySelectorAll('.item-checkbox');
        console.log('ğŸ“‹ é¡µé¢ä¸­æ‰€æœ‰å¤é€‰æ¡†æ•°é‡:', allCheckboxes.length);

        allCheckboxes.forEach((checkbox, index) => {
          console.log(`ğŸ“‹ å¤é€‰æ¡† ${index + 1}:`, {
            checked: checkbox.checked,
            bookId: checkbox.getAttribute('data-book-id'),
            element: checkbox
          });
        });

        // è·å–æ‰€æœ‰é€‰ä¸­çš„å•†å“
        const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
        console.log('âœ… é€‰ä¸­çš„å¤é€‰æ¡†æ•°é‡:', selectedCheckboxes.length);

        if (selectedCheckboxes.length === 0) {
          alert('è¯·å…ˆé€‰æ‹©è¦ç»“ç®—çš„å•†å“');
          return;
        }

        // è·å–é€‰ä¸­å•†å“çš„ID
        const selectedItemIds = Array.from(selectedCheckboxes).map(checkbox => {
          const bookId = parseInt(checkbox.getAttribute('data-book-id'));
          console.log('ğŸ“¦ è·å–å•†å“ID:', bookId);
          return bookId;
        });

        console.log('ğŸ“¦ é€‰ä¸­çš„å•†å“ID:', selectedItemIds);

        // ä¿å­˜é€‰ä¸­çš„å•†å“IDåˆ°localStorage
        localStorage.setItem('selectedCartItems', JSON.stringify(selectedItemIds));

        // è·³è½¬åˆ°ç»“ç®—é¡µé¢
        const itemsParam = selectedItemIds.join(',');
        window.location.href = `checkout.html?items=${itemsParam}`;
      }

      // å…¨é€‰å¤„ç†å‡½æ•°
      function handleSelectAll() {
        console.log('ğŸ”„ å…¨é€‰çŠ¶æ€æ”¹å˜:', this.checked);
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        itemCheckboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
        updateCartSummary();
      }

      // æ›´æ–°è´­ç‰©è½¦æ‘˜è¦ï¼ˆé€‰ä¸­å•†å“çš„æ•°é‡å’Œä»·æ ¼ï¼‰
      function updateCartSummary() {
        const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
        const selectedCountElement = document.getElementById('selectedCount');
        const totalPriceElement = document.getElementById('totalPrice');

        let totalQuantity = 0;
        let totalPrice = 0;

        selectedCheckboxes.forEach(checkbox => {
          const row = checkbox.closest('tr');
          if (row) {
            // è·å–æ•°é‡
            const quantityElement = row.querySelector('.quantity-display');
            const quantity = quantityElement ? parseInt(quantityElement.textContent) || 0 : 0;

            // è·å–å°è®¡ä»·æ ¼
            const priceCell = row.cells[4]; // ç¬¬5åˆ—æ˜¯å°è®¡
            if (priceCell) {
              const priceText = priceCell.textContent.replace('ï¿¥', '').replace(',', '');
              const price = parseFloat(priceText) || 0;
              totalPrice += price;
            }

            totalQuantity += quantity;
          }
        });

        if (selectedCountElement) {
          selectedCountElement.textContent = totalQuantity;
        }
        if (totalPriceElement) {
          totalPriceElement.textContent = totalPrice.toFixed(2);
        }
      }

      // æµ‹è¯•å¤é€‰æ¡†çŠ¶æ€
      function testCheckboxes() {
        console.log('ğŸ§ª æµ‹è¯•å¤é€‰æ¡†çŠ¶æ€');

        const allCheckboxes = document.querySelectorAll('.item-checkbox');
        const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');

        console.log('ğŸ“‹ æ‰€æœ‰å¤é€‰æ¡†:', allCheckboxes.length);
        console.log('âœ… é€‰ä¸­å¤é€‰æ¡†:', selectedCheckboxes.length);

        allCheckboxes.forEach((checkbox, index) => {
          console.log(`å¤é€‰æ¡† ${index + 1}:`, {
            checked: checkbox.checked,
            bookId: checkbox.getAttribute('data-book-id')
          });
        });

        alert(`å¤é€‰æ¡†çŠ¶æ€ï¼š\næ€»æ•°: ${allCheckboxes.length}\né€‰ä¸­: ${selectedCheckboxes.length}\n\nè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹æ§åˆ¶å°`);
      }

      // å…¨å±€æš´éœ²å‡½æ•°
      window.checkCartUserStatus = checkCartUserStatus;
      window.logout = logout;
      window.loadCartData = loadCartData;
      window.updateQuantity = updateQuantity;
      window.removeFromCart = removeFromCart;
      window.proceedToCheckout = proceedToCheckout;
      window.testCheckboxes = testCheckboxes;
    </script>
  </body>
</html>