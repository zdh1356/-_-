<!DOCTYPE html>
<html class="wide wow-animation" lang="zh-CN">
  <head>
    <!-- Site Title-->
    <title>购物车 - 华轩书店</title>
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <!-- Stylesheets-->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:700%7CLato:300,400,300italic,700">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fonts.css">
    <!-- 实时数据系统样式 -->
    <link rel="stylesheet" href="css/realtime-ui.css">
    <style>
      /* 购物车页面用户菜单样式 */
      .rd-navbar-user {
        position: relative;
      }

      .user-icon {
        display: flex;
        align-items: center;
        gap: 5px;
        color: #333;
        text-decoration: none;
        padding: 8px 12px;
        border-radius: 4px;
        transition: background-color 0.3s;
        cursor: pointer;
      }

      .user-icon:hover {
        background-color: #f5f5f5;
        text-decoration: none;
        color: #007bff;
      }

      .user-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        min-width: 150px;
        z-index: 1000;
        display: none;
      }

      .user-dropdown a {
        display: block;
        padding: 10px 15px;
        color: #333;
        text-decoration: none;
        border-bottom: 1px solid #eee;
      }

      .user-dropdown a:hover {
        background: #f5f5f5;
        color: #007bff;
      }

      .user-dropdown a:last-child {
        border-bottom: none;
      }

      /* 购物车和用户图标对齐调整 */
      .rd-navbar-user,
      .rd-navbar-cart {
        display: flex;
        align-items: center;
      }

      .rd-navbar-cart .cart-icon {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 4px;
        color: #333;
        text-decoration: none;
        transition: background-color 0.3s ease;
        position: relative;
      }

      .rd-navbar-cart .cart-icon:hover {
        background-color: #f5f5f5;
        text-decoration: none;
        color: #333;
      }

      .cart-count {
        background: #dc3545;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
        font-weight: bold;
        min-width: 18px;
        text-align: center;
        line-height: 1.2;
      }

      /* 图标大小调整 */
      .rd-navbar-user .mdi,
      .rd-navbar-cart .mdi {
        font-size: 20px;
        line-height: 1;
      }

      /* 数量控制按钮样式 */
      .quantity-controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .quantity-btn {
        background: #007bff;
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease;
      }

      .quantity-btn:hover {
        background: #0056b3;
      }

      .quantity-display {
        min-width: 40px;
        text-align: center;
        font-weight: bold;
        font-size: 16px;
        padding: 5px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #f8f9fa;
      }
    </style>
		<!--[if lt IE 10]>
    <div style="background: #212121; padding: 10px 0; box-shadow: 3px 3px 5px 0 rgba(0,0,0,.3); clear: both; text-align:center; position: relative; z-index:1;"><a href="http://windows.microsoft.com/en-US/internet-explorer/"><img src="images/ie8-panel/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="您正在使用过时的浏览器。为了获得更快更安全的浏览体验，请免费升级。"></a></div>
    <script src="js/html5shiv.min.js"></script>
		<![endif]-->
  </head>
  <body>
    <!-- Page preloader-->
    <div class="page-loader">
      <div class="page-loader-body">
        <div class="preloader-wrapper big active">
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"> </div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
          <div class="spinner-layer spinner-primary">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Page-->
    <div class="page">
      <!-- Page Header-->
      <header class="section page-header">
        <!-- RD Navbar-->
        <div class="rd-navbar-wrap rd-navbar-centered">
          <nav class="rd-navbar novi-background" data-layout="rd-navbar-fixed" data-sm-layout="rd-navbar-fixed" data-md-layout="rd-navbar-fixed" data-md-device-layout="rd-navbar-fixed" data-lg-layout="rd-navbar-fullwidth" data-lg-device-layout="rd-navbar-fixed" data-xl-layout="rd-navbar-static" data-xl-device-layout="rd-navbar-static" data-md-stick-up-offset="1px" data-lg-stick-up-offset="1px" data-stick-up="true" data-sm-stick-up="true" data-md-stick-up="true" data-lg-stick-up="true" data-xl-stick-up="true">
            <div class="rd-navbar-inner">
              <div class="rd-navbar-aside-left">
                <div class="rd-navbar-nav-wrap">
                  <!-- RD Navbar Nav-->
                  <ul class="rd-navbar-nav">
                    <li><a href="index.html">首页</a></li>
                    <li><a href="#">图书分类</a>
                      <!-- RD Navbar Dropdown-->
                      <ul class="rd-navbar-dropdown">
                        <li><a href="category.html?type=business">商业管理</a></li>
                        <li><a href="category.html?type=technology">科技计算机</a></li>
                        <li><a href="category.html?type=literature">文学艺术</a></li>
                        <li><a href="category.html?type=education">教育考试</a></li>
                        <li><a href="category.html?type=children">少儿读物</a></li>
                        <li><a href="category.html?type=life">生活休闲</a></li>
                        <li><a href="category.html?type=social">社会科学</a></li>
                      </ul>
                    </li>
                    <li><a href="recommendations.html">为您推荐</a></li>
                    <li><a href="forum.html">读者论坛</a></li>
                  </ul>
                </div>
              </div>
              <!-- RD Navbar Panel-->
              <div class="rd-navbar-panel">
                <button class="rd-navbar-toggle" data-rd-navbar-toggle=".rd-navbar-nav-wrap"><span></span></button>
                <!-- RD Navbar Brand-->
                <div class="rd-navbar-brand"><a class="brand-name" href="index.html"><img class="logo-default" src="images/logo-default-161x57.png" alt="华轩书店" width="161" height="57"/><img class="logo-inverse" src="images/logo-inverse-161x57.png" alt="华轩书店" width="161" height="57"/></a></div>
              </div>
              <div class="rd-navbar-collapse-toggle" data-rd-navbar-toggle=".rd-navbar-collapse"><span></span></div>
              <div class="rd-navbar-aside-right rd-navbar-collapse">
                <!-- RD Navbar Search-->
                <div class="rd-navbar-search"><a class="rd-navbar-search-toggle" data-rd-navbar-toggle=".rd-navbar-search" href="#"><span></span></a>
                  <form class="rd-search" action="search.html" data-search-live="rd-search-results-live" method="GET">
                    <div class="form-wrap">
                      <label class="form-label form-label" for="rd-navbar-search-form-input">搜索图书...</label>
                      <input class="rd-navbar-search-form-input form-input" id="rd-navbar-search-form-input" type="text" name="keyword" autocomplete="off">
                      <div class="rd-search-results-live"></div>
                    </div>
                    <button class="rd-search-form-submit mdi mdi-magnify"></button>
                  </form>
                </div>
                <!-- User Menu -->
                <div class="rd-navbar-user">
                  <a href="login-page.html" class="user-icon" id="userMenu">
                    <i class="mdi mdi-account"></i>
                    <span id="userDisplayName">登录</span>
                  </a>
                  <div class="user-dropdown" id="userDropdown" style="display: none;">
                    <a href="user-profile.html">个人资料</a>
                    <a href="order-history.html">我的订单</a>
                    <a href="browsing-history.html">浏览历史</a>
                    <a href="user-preferences.html">偏好设置</a>
                    <a href="change-password.html">修改密码</a>
                    <a href="#" onclick="logout()">退出登录</a>
                  </div>
                </div>
                <!-- Shopping Cart -->
                <div class="rd-navbar-cart">
                  <a href="shopping-cart.html" class="cart-icon" id="cartIcon">
                    <i class="mdi mdi-cart"></i>
                    <span class="cart-count" id="cartCount">0</span>
                  </a>
                </div>
              </div>
            </div>
          </nav>
        </div>
      </header>
      <!-- Breadcrumbs-->
      <section class="breadcrumbs-custom" style="background-image: url(images/breadcrumbs-bg.jpg)">
        <div class="container">
          <p class="breadcrumbs-custom-subtitle">我的购物车</p>
          <p class="heading-1 breadcrumbs-custom-title">购物车</p>
          <ul class="breadcrumbs-custom-path">
            <li><a href="index.html">首页</a></li>
            <li class="active">购物车</li>
          </ul>
        </div>
      </section>

      <!-- Shopping Cart-->
      <section class="section section-lg bg-default">
        <div class="container">
          <div class="row">
            <div class="col-12">
              <!-- Shopping Cart Table-->
              <div class="table-responsive">
                <table class="table table-cart">
                  <thead>
                    <tr>
                      <th>
                        <div class="checkbox-inline">
                          <label>
                            <input type="checkbox" id="selectAll">
                            <span class="checkbox-inline__box"></span>
                          </label>
                        </div>
                      </th>
                      <th>图书信息</th>
                      <th>单价</th>
                      <th>数量</th>
                      <th>小计</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="cartItems">
                    <!-- Cart items will be loaded here -->
                  </tbody>
                </table>
              </div>
              <!-- Cart Actions-->
              <div class="row align-items-center" style="margin-top: 20px;">
                <div class="col-md-6">
                  <div style="display: flex; align-items: flex-end;">
                    <button class="button button-primary" id="clearCart" style="margin-right: 15px; width: 120px; height: 48px; display: flex; align-items: center; justify-content: center;">清空购物车</button>
                    <button class="button button-primary" id="continueShop" style="width: 120px; height: 48px; display: flex; align-items: center; justify-content: center;">继续购物</button>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="cart-total text-right d-flex align-items-center justify-content-end">
                    <span>已选择 <span id="selectedCount">0</span> 件商品</span>
                    <span style="margin-left: 20px;">合计：￥<span id="totalPrice">0.00</span></span>
                    <button class="button button-secondary" onclick="testCheckboxes()" style="margin-left: 20px; min-width: 80px; height: 48px; padding: 12px 15px;">测试</button>
                    <button class="button button-primary" id="checkout" style="margin-left: 10px; min-width: 100px; height: 48px; padding: 12px 20px;">结算</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Recommended Books-->
      <section class="section section-lg bg-gray-lighter">
        <div class="container">
          <h3>猜你喜欢</h3>
          <div class="row row-30" id="recommendedBooks">
            <!-- Recommended books will be loaded here -->
          </div>
        </div>
      </section>
    </div>
    <!-- Global Mailform Output-->
    <div class="snackbars" id="form-output-global"></div>
    <!-- Javascript-->
    <script src="js/core.min.js"></script>
    <script src="js/script.js"></script>

    <!-- 实时数据系统脚本 -->
    <script src="js/realtime-data-manager.js"></script>
    <script src="js/page-adapters.js"></script>

    <!-- 购物车页面用户状态管理 -->
    <script>
      // 购物车页面用户状态检查
      function checkCartUserStatus() {
        console.log('🔍 检查用户状态 - 购物车页面');

        const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const userInfoStr = localStorage.getItem('userInfo');
        const username = localStorage.getItem('username');

        console.log('登录数据:', { authToken: !!authToken, isLoggedIn, userInfoStr: !!userInfoStr, username });

        const userMenu = document.getElementById('userMenu');
        const userDisplayName = document.getElementById('userDisplayName');
        const userDropdown = document.getElementById('userDropdown');

        if (!userMenu || !userDisplayName) {
          console.error('❌ 购物车页面用户菜单元素未找到');
          return;
        }

        let userInfo = {};
        if (userInfoStr) {
          try {
            userInfo = JSON.parse(userInfoStr);
          } catch (error) {
            console.error('❌ 解析用户信息失败:', error);
          }
        }

        // 检查是否已登录（多重检查）
        const hasValidLogin = (
          (authToken && authToken !== 'null') &&
          (isLoggedIn === 'true') &&
          (userInfo.username || username)
        );

        console.log('登录状态判断:', hasValidLogin);

        if (hasValidLogin) {
          // 用户已登录
          const displayName = userInfo.username || username || '用户';
          console.log('✅ 用户已登录:', displayName);

          userDisplayName.textContent = displayName;
          userMenu.href = '#';

          // 绑定下拉菜单事件
          userMenu.onclick = function(e) {
            e.preventDefault();
            if (userDropdown) {
              const isHidden = userDropdown.style.display === 'none' || !userDropdown.style.display;
              userDropdown.style.display = isHidden ? 'block' : 'none';
            }
          };
        } else {
          // 用户未登录
          console.log('❌ 用户未登录');
          userDisplayName.textContent = '登录';
          userMenu.href = 'login-page.html';
          userMenu.onclick = null;

          if (userDropdown) {
            userDropdown.style.display = 'none';
          }
        }
      }

      // 注销功能
      function logout() {
        if (confirm('确定要退出登录吗？')) {
          console.log('🚪 购物车页面用户注销');
          localStorage.removeItem('userInfo');
          localStorage.removeItem('authToken');
          localStorage.removeItem('token');
          localStorage.removeItem('cart');

          // 跳转到首页
          window.location.href = 'index.html';
        }
      }

      // 页面加载时检查用户状态和加载购物车数据
      document.addEventListener('DOMContentLoaded', function() {
        checkCartUserStatus();
        loadCartData();

        // 绑定结算按钮事件
        const checkoutButton = document.getElementById('checkout');
        if (checkoutButton) {
          checkoutButton.addEventListener('click', proceedToCheckout);
        }

        // 绑定全选功能（初始绑定）
        const selectAllCheckbox = document.getElementById('selectAll');
        if (selectAllCheckbox) {
          selectAllCheckbox.addEventListener('change', handleSelectAll);
          console.log('🔗 初始全选复选框事件已绑定');
        }
      });

      // 监听存储变化
      window.addEventListener('storage', function(e) {
        if (e.key === 'authToken' || e.key === 'token' || e.key === 'userInfo') {
          console.log('💾 购物车页面检测到存储变化，更新用户状态');
          checkCartUserStatus();
        }
      });

      // 加载购物车数据
      async function loadCartData() {
        const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!authToken) {
          displayEmptyCart();
          return;
        }

        try {
          const response = await fetch('http://1.94.203.175:5000/api/order/cart', {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });

          if (response.ok) {
            const result = await response.json();
            if (result.data && result.data.items && result.data.items.length > 0) {
              displayCartItems(result.data.items);
            } else {
              displayEmptyCart();
            }
          } else {
            displayEmptyCart();
          }
        } catch (error) {
          console.error('加载购物车数据失败:', error);
          displayEmptyCart();
        }
      }

      // 显示购物车商品
      function displayCartItems(items) {
        const cartContainer = document.getElementById('cartItems');
        if (!cartContainer) {
          console.error('❌ 购物车容器未找到');
          return;
        }

        let totalPrice = 0;
        let totalItems = 0;

        const cartHTML = items.map(item => {
          console.log('🛒 处理购物车商品:', item);

          // 从数据库返回的完整图书信息
          const book = item.book || {};
          const title = book.title || item.title || '未知图书';
          const author = book.author || item.author || '未知作者';
          const publisher = book.publisher || item.publisher || '未知出版社';
          const price = parseFloat(book.currentPrice || item.price || 0);
          const coverImage = book.coverImageUrl || item.cover || 'images/default-book.svg';
          const quantity = parseInt(item.quantity || 1);
          const itemTotal = price * quantity;

          totalPrice += itemTotal;
          totalItems += quantity;

          return `
            <tr>
              <td>
                <div class="checkbox-inline">
                  <label>
                    <input type="checkbox" class="item-checkbox" data-book-id="${item.bookId}" data-item-id="${item.id}">
                    <span class="checkbox-inline__box"></span>
                  </label>
                </div>
              </td>
              <td>
                <div class="product-cart">
                  <div class="product-cart-img">
                    <img src="${coverImage}" alt="${title}" width="80" height="100">
                  </div>
                  <div class="product-cart-info">
                    <h6>${title}</h6>
                    <p>作者: ${author}</p>
                    <p>出版社: ${publisher}</p>
                  </div>
                </div>
              </td>
              <td>￥${price.toFixed(2)}</td>
              <td>
                <div class="quantity-controls">
                  <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${Math.max(1, quantity - 1)})">-</button>
                  <span class="quantity-display">${quantity}</span>
                  <button class="quantity-btn" onclick="updateQuantity(${item.id}, ${quantity + 1})">+</button>
                </div>
              </td>
              <td>￥${itemTotal.toFixed(2)}</td>
              <td>
                <button class="button button-sm button-secondary" onclick="removeFromCart(${item.id})">删除</button>
              </td>
            </tr>
          `;
        }).join('');

        cartContainer.innerHTML = cartHTML;
        console.log('✅ 购物车HTML已插入');

        // 延迟绑定事件，确保DOM更新完成
        setTimeout(() => {
          // 为复选框添加事件监听
          const itemCheckboxes = document.querySelectorAll('.item-checkbox');
          console.log('🔗 找到复选框数量:', itemCheckboxes.length);

          itemCheckboxes.forEach((checkbox, index) => {
            console.log(`🔗 绑定复选框 ${index + 1} 事件，bookId:`, checkbox.getAttribute('data-book-id'));
            checkbox.addEventListener('change', function() {
              console.log('✅ 复选框状态改变:', this.checked, 'bookId:', this.getAttribute('data-book-id'));
              updateCartSummary();
            });
          });

          // 重新绑定全选功能
          const selectAllCheckbox = document.getElementById('selectAll');
          if (selectAllCheckbox) {
            // 移除旧的事件监听器
            selectAllCheckbox.removeEventListener('change', handleSelectAll);
            // 添加新的事件监听器
            selectAllCheckbox.addEventListener('change', handleSelectAll);
            console.log('🔗 全选复选框事件已重新绑定');
          }
        }, 100);

        // 更新总计显示（显示所有商品的总计）
        const selectedCountElement = document.getElementById('selectedCount');
        const totalPriceElement = document.getElementById('totalPrice');

        if (selectedCountElement) {
          selectedCountElement.textContent = '0'; // 初始为0，等待用户选择
        }
        if (totalPriceElement) {
          totalPriceElement.textContent = '0.00'; // 初始为0，等待用户选择
        }
      }

      // 显示空购物车
      function displayEmptyCart() {
        const cartContainer = document.getElementById('cartItems');
        if (!cartContainer) {
          console.error('❌ 购物车容器未找到');
          return;
        }

        cartContainer.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 50px;">
              <div class="empty-cart">
                <div style="font-size: 48px; margin-bottom: 20px;">🛒</div>
                <h4>购物车是空的</h4>
                <p style="color: #666; margin: 20px 0;">快去挑选您喜欢的图书吧！</p>
                <a href="category.html" class="button button-primary">去购物</a>
              </div>
            </td>
          </tr>
        `;

        // 重置总计显示
        const selectedCountElement = document.getElementById('selectedCount');
        const totalPriceElement = document.getElementById('totalPrice');

        if (selectedCountElement) {
          selectedCountElement.textContent = '0';
        }
        if (totalPriceElement) {
          totalPriceElement.textContent = '0.00';
        }
      }

      // 更新商品数量
      async function updateQuantity(itemId, newQuantity) {
        if (newQuantity < 1) {
          removeFromCart(itemId);
          return;
        }

        const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!authToken) {
          alert('请先登录');
          return;
        }

        try {
          const response = await fetch('http://1.94.203.175:5000/api/order/cart/update', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
              itemId: itemId,
              quantity: newQuantity
            })
          });

          if (response.ok) {
            loadCartData(); // 重新加载购物车数据
          } else {
            const result = await response.json();
            alert(result.message || '更新失败，请重试');
          }
        } catch (error) {
          console.error('更新数量失败:', error);
          alert('更新失败，请重试');
        }
      }

      // 从购物车删除商品
      async function removeFromCart(itemId) {
        if (!confirm('确定要删除这件商品吗？')) {
          return;
        }

        const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!authToken) {
          alert('请先登录');
          return;
        }

        try {
          const response = await fetch(`http://1.94.203.175:5000/api/order/cart/remove?itemId=${itemId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });

          if (response.ok) {
            loadCartData(); // 重新加载购物车数据
          } else {
            const result = await response.json();
            alert(result.message || '删除失败，请重试');
          }
        } catch (error) {
          console.error('删除商品失败:', error);
          alert('删除失败，请重试');
        }
      }

      // 去结算
      function proceedToCheckout() {
        console.log('🛒 开始结算流程');

        // 先检查所有复选框
        const allCheckboxes = document.querySelectorAll('.item-checkbox');
        console.log('📋 页面中所有复选框数量:', allCheckboxes.length);

        allCheckboxes.forEach((checkbox, index) => {
          console.log(`📋 复选框 ${index + 1}:`, {
            checked: checkbox.checked,
            bookId: checkbox.getAttribute('data-book-id'),
            element: checkbox
          });
        });

        // 获取所有选中的商品
        const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
        console.log('✅ 选中的复选框数量:', selectedCheckboxes.length);

        if (selectedCheckboxes.length === 0) {
          alert('请先选择要结算的商品');
          return;
        }

        // 获取选中商品的ID
        const selectedItemIds = Array.from(selectedCheckboxes).map(checkbox => {
          const bookId = parseInt(checkbox.getAttribute('data-book-id'));
          console.log('📦 获取商品ID:', bookId);
          return bookId;
        });

        console.log('📦 选中的商品ID:', selectedItemIds);

        // 保存选中的商品ID到localStorage
        localStorage.setItem('selectedCartItems', JSON.stringify(selectedItemIds));

        // 跳转到结算页面
        const itemsParam = selectedItemIds.join(',');
        window.location.href = `checkout.html?items=${itemsParam}`;
      }

      // 全选处理函数
      function handleSelectAll() {
        console.log('🔄 全选状态改变:', this.checked);
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        itemCheckboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
        updateCartSummary();
      }

      // 更新购物车摘要（选中商品的数量和价格）
      function updateCartSummary() {
        const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
        const selectedCountElement = document.getElementById('selectedCount');
        const totalPriceElement = document.getElementById('totalPrice');

        let totalQuantity = 0;
        let totalPrice = 0;

        selectedCheckboxes.forEach(checkbox => {
          const row = checkbox.closest('tr');
          if (row) {
            // 获取数量
            const quantityElement = row.querySelector('.quantity-display');
            const quantity = quantityElement ? parseInt(quantityElement.textContent) || 0 : 0;

            // 获取小计价格
            const priceCell = row.cells[4]; // 第5列是小计
            if (priceCell) {
              const priceText = priceCell.textContent.replace('￥', '').replace(',', '');
              const price = parseFloat(priceText) || 0;
              totalPrice += price;
            }

            totalQuantity += quantity;
          }
        });

        if (selectedCountElement) {
          selectedCountElement.textContent = totalQuantity;
        }
        if (totalPriceElement) {
          totalPriceElement.textContent = totalPrice.toFixed(2);
        }
      }

      // 测试复选框状态
      function testCheckboxes() {
        console.log('🧪 测试复选框状态');

        const allCheckboxes = document.querySelectorAll('.item-checkbox');
        const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');

        console.log('📋 所有复选框:', allCheckboxes.length);
        console.log('✅ 选中复选框:', selectedCheckboxes.length);

        allCheckboxes.forEach((checkbox, index) => {
          console.log(`复选框 ${index + 1}:`, {
            checked: checkbox.checked,
            bookId: checkbox.getAttribute('data-book-id')
          });
        });

        alert(`复选框状态：\n总数: ${allCheckboxes.length}\n选中: ${selectedCheckboxes.length}\n\n详细信息请查看控制台`);
      }

      // 全局暴露函数
      window.checkCartUserStatus = checkCartUserStatus;
      window.logout = logout;
      window.loadCartData = loadCartData;
      window.updateQuantity = updateQuantity;
      window.removeFromCart = removeFromCart;
      window.proceedToCheckout = proceedToCheckout;
      window.testCheckboxes = testCheckboxes;
    </script>
  </body>
</html>